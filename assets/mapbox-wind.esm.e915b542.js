import{m as x}from"./index.6b9c35f5.js";const dt=Object.prototype.hasOwnProperty,R=typeof Symbol<"u"?Symbol.toStringTag:void 0;function gt(s){if(s===null)return s===void 0?"[object Undefined]":"[object Null]";if(!(R&&R in Object(s)))return toString.call(s);const t=dt.call(s,R),e=s[R];let i=!1;try{s[R]=void 0,i=!0}catch{}const r=Object.prototype.toString.call(s);return i&&(t?s[R]=e:delete s[R]),r}function W(s){if(!ft(s))return!1;const t=gt(s);return t==="[object Function]"||t==="[object AsyncFunction]"||t==="[object GeneratorFunction]"||t==="[object Proxy]"}function ft(s){const t=typeof s;return s!==null&&(t==="object"||t==="function")}function pt(s){return s==null?!1:typeof s=="string"||s.constructor!==null&&s.constructor===String}function N(s){return Object.prototype.toString.call(s)==="[object Number]"&&!isNaN(s)}function mt(s){return Array.isArray(s)}function k(s,...t){return Object.assign(s,...t)}function xt(s,t){console.warn(`${t||"wind-layer"}: ${s}`)}const j={};function vt(s,t){j[t]||(xt(t,s),j[t]=!0)}function Bt(s,t){return s-t*Math.floor(s/t)}function A(s){return s!=null&&!isNaN(s)}function It(s,t={}){let e,i;if(s.forEach(function(n){switch(n.header.parameterCategory+","+n.header.parameterNumber){case"1,2":case"2,2":e=n;break;case"1,3":case"2,3":i=n;break}}),!i||!e)return;const r=e.header;return new at({xmin:r.lo1,ymin:r.la1,xmax:r.lo2,ymax:r.la2,deltaX:r.dx,deltaY:r.dy,cols:r.nx,rows:r.ny,us:e.data,vs:i.data,...t})}class H{constructor(t,e){this.u=t,this.v=e,this.m=this.magnitude()}magnitude(){return Math.sqrt(this.u**2+this.v**2)}directionTo(){let e=Math.atan2(this.u,this.v)*(180/Math.PI);return e<0&&(e+=360),e}directionFrom(){return(this.directionTo()+180)%360}}class at{constructor(t){this.grid=[],this.xmin=t.xmin,this.xmax=t.xmax,this.ymin=t.ymin,this.ymax=t.ymax,this.cols=t.cols,this.rows=t.rows,this.us=t.us,this.vs=t.vs,this.deltaX=t.deltaX,this.deltaY=t.deltaY,this.flipY=Boolean(t.flipY),this.ymin=Math.min(t.ymax,t.ymin),this.ymax=Math.max(t.ymax,t.ymin),this.deltaY<0&&this.ymin<this.ymax||(t.flipY===void 0&&(this.flipY=!0),console.warn("[wind-core]: The data is flipY")),this.isFields=!0;const e=Math.ceil((this.xmax-this.xmin)/t.deltaX),i=Math.ceil((this.ymax-this.ymin)/t.deltaY);(e!==this.cols||i!==this.rows)&&console.warn("[wind-core]: The data grid not equal"),this.isContinuous=Math.floor(this.cols*t.deltaX)>=360,this.translateX="translateX"in t?t.translateX:this.xmax>180,"wrappedX"in t&&vt("[wind-core]: ","`wrappedX` namespace will deprecated please use `translateX` instead\uFF01"),this.wrapX=Boolean(t.wrapX),this.grid=this.buildGrid(),this.range=this.calculateRange()}buildGrid(){let t=[],e=0;const{rows:i,cols:r,us:o,vs:n}=this;for(let a=0;a<i;a++){const c=[];for(let l=0;l<r;l++,e++){let h=o[e],u=n[e],d=this.isValid(h)&&this.isValid(u);c[l]=d?new H(h,u):null}this.isContinuous&&c.push(c[0]),t[a]=c}return t}release(){this.grid=[]}extent(){return[this.xmin,this.ymin,this.xmax,this.ymax]}bilinearInterpolateVector(t,e,i,r,o,n){const a=1-t,c=1-e,l=a*c,h=t*c,u=a*e,d=t*e,f=i.u*l+r.u*h+o.u*u+n.u*d,_=i.v*l+r.v*h+o.v*u+n.v*d;return new H(f,_)}calculateRange(){if(!this.grid||!this.grid[0])return;const t=this.grid.length,e=this.grid[0].length;let i,r;for(let o=0;o<t;o++)for(let n=0;n<e;n++){const a=this.grid[o][n];if(a!==null){const c=a.m||a.magnitude();i===void 0?i=c:r===void 0?(r=c,i=Math.min(i,r),r=Math.max(i,r)):(i=Math.min(c,i),r=Math.max(c,r))}}return[i,r]}isValid(t){return t!=null}getWrappedLongitudes(){let t=this.xmin,e=this.xmax;return this.translateX&&(this.isContinuous?(t=-180,e=180):(e=this.xmax-360,t=this.xmin-360)),[t,e]}contains(t,e){const[i,r]=this.getWrappedLongitudes();let o=t>=i&&t<=r,n;return this.deltaY>=0?n=e>=this.ymin&&e<=this.ymax:n=e>=this.ymax&&e<=this.ymin,o&&n}getDecimalIndexes(t,e){const i=Bt(t-this.xmin,360)/this.deltaX;if(this.flipY){const r=(this.ymax-e)/this.deltaY;return[i,r]}else{const r=(this.ymin+e)/this.deltaY;return[i,r]}}valueAt(t,e){let i=!1;if((this.wrapX||this.contains(t,e))&&(i=!0),!i)return null;const r=this.getDecimalIndexes(t,e);let o=Math.floor(r[0]),n=Math.floor(r[1]);const a=this.clampColumnIndex(o),c=this.clampRowIndex(n);return this.valueAtIndexes(a,c)}interpolatedValueAt(t,e){let i=!1;if((this.wrapX||this.contains(t,e))&&(i=!0),!i)return null;let[r,o]=this.getDecimalIndexes(t,e);return this.interpolatePoint(r,o)}hasValueAt(t,e){return this.valueAt(t,e)!==null}interpolatePoint(t,e){const i=this.getFourSurroundingIndexes(t,e),[r,o,n,a]=i;let c=this.getFourSurroundingValues(r,o,n,a);if(c){const[l,h,u,d]=c;return this.bilinearInterpolateVector(t-r,e-n,l,h,u,d)}return null}clampColumnIndex(t){let e=t;t<0&&(e=0);let i=this.cols-1;return t>i&&(e=i),e}clampRowIndex(t){let e=t;t<0&&(e=0);let i=this.rows-1;return t>i&&(e=i),e}getFourSurroundingIndexes(t,e){let i=Math.floor(t),r=i+1;this.isContinuous&&r>=this.cols&&(r=0),r=this.clampColumnIndex(r);let o=this.clampRowIndex(Math.floor(e)),n=this.clampRowIndex(o+1);return[i,r,o,n]}getFourSurroundingValues(t,e,i,r){let o;if(o=this.grid[i]){const n=o[t],a=o[e];if(this.isValid(n)&&this.isValid(a)&&(o=this.grid[r])){const c=o[t],l=o[e];if(this.isValid(c)&&this.isValid(l))return[n,a,c,l]}}return null}valueAtIndexes(t,e){return this.grid[e][t]}lonLatAtIndexes(t,e){let i=this.longitudeAtX(t),r=this.latitudeAtY(e);return[i,r]}longitudeAtX(t){let e=this.deltaX/2,i=this.xmin+e+t*this.deltaX;return this.translateX&&(i=i>180?i-360:i),i}latitudeAtY(t){let e=this.deltaY/2;return this.ymax-e-t*this.deltaY}randomize(t={},e,i,r){let o=Math.random()*(e||this.cols)|0,n=Math.random()*(i||this.rows)|0;const a=r([o,n]);return a!==null?(t.x=a[0],t.y=a[1]):(t.x=this.longitudeAtX(o),t.y=this.latitudeAtY(n)),t}checkFields(){return this.isFields}}const O={globalAlpha:.9,lineWidth:1,colorScale:"#fff",velocityScale:1/25,maxAge:90,paths:800,frameRate:20,useCoordsDraw:!0,gpet:!0};function K(s,t,e,i){return Math.max(0,Math.min(i.length-1,Math.round((s-t)/(e-t)*(i.length-1))))}class ct{constructor(t,e,i){if(this.particles=[],this.generated=!1,this.ctx=t,!this.ctx)throw new Error("ctx error");this.animate=this.animate.bind(this),this.setOptions(e),i&&this.updateData(i)}setOptions(t){this.options={...O,...t};const{width:e,height:i}=this.ctx.canvas;"particleAge"in t&&!("maxAge"in t)&&N(this.options.particleAge)&&(this.options.maxAge=this.options.particleAge),"particleMultiplier"in t&&!("paths"in t)&&N(this.options.particleMultiplier)&&(this.options.paths=Math.round(e*i*this.options.particleMultiplier)),this.prerender()}getOptions(){return this.options}updateData(t){this.field=t,this.generated&&(this.particles=this.prepareParticlePaths())}project(...t){throw new Error("project must be overriden")}unproject(...t){throw new Error("unproject must be overriden")}intersectsCoordinate(t){throw new Error("must be overriden")}clearCanvas(){this.stop(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.forceStop=!1}start(){this.starting=!0,this.forceStop=!1,this.then=Date.now(),this.animate()}stop(){cancelAnimationFrame(this.animationLoop),this.starting=!1,this.forceStop=!0}animate(){this.animationLoop&&cancelAnimationFrame(this.animationLoop),this.animationLoop=requestAnimationFrame(this.animate);const t=Date.now(),e=t-this.then;e>this.options.frameRate&&(this.then=t-e%this.options.frameRate,this.render())}prerender(){this.generated=!1,this.field&&(this.particles=this.prepareParticlePaths(),this.generated=!0,!this.starting&&!this.forceStop&&(this.starting=!0,this.then=Date.now(),this.animate()))}render(){this.moveParticles(),this.drawParticles(),this.postrender()}postrender(){}moveParticles(){const{width:t,height:e}=this.ctx.canvas,i=this.particles,r=this.options.maxAge,o=W(this.options.velocityScale)?this.options.velocityScale():this.options.velocityScale;let n=0;const a=i.length;for(;n<a;n++){const c=i[n];c.age>r&&(c.age=0,this.field.randomize(c,t,e,this.unproject));const l=c.x,h=c.y,u=this.field.interpolatedValueAt(l,h);if(u===null)c.age=r;else{const d=l+u.u*o,f=h+u.v*o;this.field.hasValueAt(d,f)?(c.xt=d,c.yt=f,c.m=u.m):(c.x=d,c.y=f,c.age=r)}c.age++}}fadeIn(){const t=this.ctx.globalCompositeOperation;this.ctx.globalCompositeOperation="destination-in",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.globalCompositeOperation=t}drawParticles(){const t=this.particles;this.fadeIn(),this.ctx.globalAlpha=this.options.globalAlpha,this.ctx.fillStyle=`rgba(0, 0, 0, ${this.options.globalAlpha})`,this.ctx.lineWidth=N(this.options.lineWidth)?this.options.lineWidth:1,this.ctx.strokeStyle=pt(this.options.colorScale)?this.options.colorScale:"#fff";let e=0;const i=t.length;if(this.field&&i>0){let r,o;for(A(this.options.minVelocity)&&A(this.options.maxVelocity)?(r=this.options.minVelocity,o=this.options.maxVelocity):[r,o]=this.field.range;e<i;e++)this[this.options.useCoordsDraw?"drawCoordsParticle":"drawPixelParticle"](t[e],r,o)}}drawPixelParticle(t,e,i){const r=[t.x,t.y],o=[t.xt,t.yt];if(o&&r&&A(o[0])&&A(o[1])&&A(r[0])&&A(r[1])&&t.age<=this.options.maxAge){if(this.ctx.beginPath(),this.ctx.moveTo(r[0],r[1]),this.ctx.lineTo(o[0],o[1]),W(this.options.colorScale))this.ctx.strokeStyle=this.options.colorScale(t.m);else if(Array.isArray(this.options.colorScale)){const n=K(t.m,e,i,this.options.colorScale);this.ctx.strokeStyle=this.options.colorScale[n]}W(this.options.lineWidth)&&(this.ctx.lineWidth=this.options.lineWidth(t.m)),t.x=t.xt,t.y=t.yt,this.ctx.stroke()}}drawCoordsParticle(t,e,i){const r=[t.x,t.y],o=[t.xt,t.yt];if(o&&r&&A(o[0])&&A(o[1])&&A(r[0])&&A(r[1])&&this.intersectsCoordinate(o)&&t.age<=this.options.maxAge){const n=this.project(r),a=this.project(o);if(n&&a){if(this.ctx.beginPath(),this.ctx.moveTo(n[0],n[1]),this.ctx.lineTo(a[0],a[1]),t.x=t.xt,t.y=t.yt,W(this.options.colorScale))this.ctx.strokeStyle=this.options.colorScale(t.m);else if(Array.isArray(this.options.colorScale)){const c=K(t.m,e,i,this.options.colorScale);this.ctx.strokeStyle=this.options.colorScale[c]}W(this.options.lineWidth)&&(this.ctx.lineWidth=this.options.lineWidth(t.m)),this.ctx.stroke()}}}prepareParticlePaths(){const{width:t,height:e}=this.ctx.canvas,i=typeof this.options.paths=="function"?this.options.paths(this):this.options.paths,r=[];if(!this.field)return[];let o=0;for(;o<i;o++)r.push(this.field.randomize({age:this.randomize()},t,e,this.unproject));return r}randomize(){return Math.floor(Math.random()*this.options.maxAge)}}ct.Field=at;var lt=null;try{var bt=typeof module<"u"&&typeof module.require=="function"&&module.require("worker_threads")||typeof __non_webpack_require__=="function"&&__non_webpack_require__("worker_threads")||typeof require=="function"&&require("worker_threads");lt=bt.Worker}catch{}function _t(s,t){return Buffer.from(s,"base64").toString(t?"utf16":"utf8")}function yt(s,t,e){var i=t===void 0?null:t,r=e===void 0?!1:e,o=_t(s,r),n=o.indexOf(`
`,10)+1,a=o.substring(n)+(i?"//# sourceMappingURL="+i:"");return function(l){return new lt(a,Object.assign({},l,{eval:!0}))}}function Ft(s,t){var e=atob(s);if(t){for(var i=new Uint8Array(e.length),r=0,o=e.length;r<o;++r)i[r]=e.charCodeAt(r);return String.fromCharCode.apply(null,new Uint16Array(i.buffer))}return e}function Et(s,t,e){var i=t===void 0?null:t,r=e===void 0?!1:e,o=Ft(s,r),n=o.indexOf(`
`,10)+1,a=o.substring(n)+(i?"//# sourceMappingURL="+i:""),c=new Blob([a],{type:"application/javascript"});return URL.createObjectURL(c)}function St(s,t,e){var i;return function(o){return i=i||Et(s,t,e),new Worker(i,o)}}var Ct=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]";function At(){return Ct}function wt(s,t,e){return At()?yt(s,t,e):St(s,t,e)}var Qt=wt("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gY2FsY01pbk1heChhcnJheSkgewogICAgbGV0IG1pbiA9IEluZmluaXR5OwogICAgbGV0IG1heCA9IEluZmluaXR5OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB2YWwgPSBhcnJheVtpXTsKICAgICAgaWYgKG1pbiA9PT0gSW5maW5pdHkpIHsKICAgICAgICBtaW4gPSB2YWw7CiAgICAgIH0gZWxzZSBpZiAobWF4ID09PSBJbmZpbml0eSkgewogICAgICAgIG1heCA9IHZhbDsKICAgICAgICBtaW4gPSBNYXRoLm1pbihtaW4sIG1heCk7CiAgICAgICAgbWF4ID0gTWF0aC5tYXgobWluLCBtYXgpOwogICAgICB9IGVsc2UgewogICAgICAgIG1pbiA9IE1hdGgubWluKHZhbCwgbWluKTsKICAgICAgICBtYXggPSBNYXRoLm1heCh2YWwsIG1heCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbbWluLCBtYXhdOwogIH0KCiAgY29uc3QgY3R4ID0gc2VsZjsKICBjdHguYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGFzeW5jICh7IGRhdGE6IHBheWxvYWQgfSkgPT4gewogICAgY29uc3QgcmVuZGVyRm9ybSA9IHBheWxvYWRbMF07CiAgICBpZiAocmVuZGVyRm9ybSA9PT0gInJnIikgewogICAgICBjb25zdCB1RGF0YSA9IHBheWxvYWRbMV07CiAgICAgIGNvbnN0IHZEYXRhID0gcGF5bG9hZFsyXTsKICAgICAgY29uc3QgW3VNaW4sIHVNYXhdID0gY2FsY01pbk1heCh1RGF0YSk7CiAgICAgIGNvbnN0IFt2TWluLCB2TWF4XSA9IGNhbGNNaW5NYXgodkRhdGEpOwogICAgICBjb25zdCB2ZWxvY2l0eURhdGEgPSBuZXcgVWludDhBcnJheSh1RGF0YS5sZW5ndGggKiA0KTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1RGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHIgPSAyNTUgKiAodURhdGFbaV0gLSB1TWluKSAvICh1TWF4IC0gdU1pbik7CiAgICAgICAgY29uc3QgZyA9IDI1NSAqICh2RGF0YVtpXSAtIHZNaW4pIC8gKHZNYXggLSB2TWluKTsKICAgICAgICB2ZWxvY2l0eURhdGEuc2V0KFtyLCBnLCAwLCAyNTVdLCBpICogNCk7CiAgICAgIH0KICAgICAgY3R4LnBvc3RNZXNzYWdlKFt2ZWxvY2l0eURhdGEuYnVmZmVyLCB1TWluLCB1TWF4LCB2TWluLCB2TWF4XSwgW3ZlbG9jaXR5RGF0YS5idWZmZXJdKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHNpbmdsZURhdGEgPSBwYXlsb2FkWzFdOwogICAgICBjb25zdCBbbWluLCBtYXhdID0gY2FsY01pbk1heChzaW5nbGVEYXRhKTsKICAgICAgY29uc3QgdmVsb2NpdHlEYXRhID0gbmV3IFVpbnQ4QXJyYXkoc2luZ2xlRGF0YS5sZW5ndGggKiA0KTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaW5nbGVEYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgciA9IDI1NSAqIChzaW5nbGVEYXRhW2ldIC0gbWluKSAvIChtYXggLSBtaW4pOwogICAgICAgIHZlbG9jaXR5RGF0YS5zZXQoW3IsIDAsIDAsIDI1NV0sIGkgKiA0KTsKICAgICAgfQogICAgICBjdHgucG9zdE1lc3NhZ2UoW3ZlbG9jaXR5RGF0YS5idWZmZXIsIG1pbiwgbWF4XSwgW3ZlbG9jaXR5RGF0YS5idWZmZXJdKTsKICAgIH0KICB9KTsKCn0pKCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPURhdGFQcm9jZXNzZS5qcy5tYXAKCg==","data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0YVByb2Nlc3NlLmpzIiwic291cmNlcyI6WyJ3b3JrZXI6Ly93ZWItd29ya2VyL3V0aWxzL2NvbW1vbi50cyIsIndvcmtlcjovL3dlYi13b3JrZXIvd29ya2Vycy9EYXRhUHJvY2Vzc2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGZ1bmN0aW9uIGNhbGNNaW5NYXgoYXJyYXk6IG51bWJlcltdKTogW251bWJlciwgbnVtYmVyXSB7XG4gIGxldCBtaW4gPSBJbmZpbml0eTtcbiAgbGV0IG1heCA9IEluZmluaXR5O1xuICAvLyBAZnJvbTogaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTM1NDQ0NzYvaG93LXRvLWZpbmQtbWF4LWFuZC1taW4taW4tYXJyYXktdXNpbmctbWluaW11bS1jb21wYXJpc29uc1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgdmFsID0gYXJyYXlbaV07XG5cbiAgICBpZiAobWluID09PSBJbmZpbml0eSkge1xuICAgICAgbWluID0gdmFsO1xuICAgIH0gZWxzZSBpZiAobWF4ID09PSBJbmZpbml0eSkge1xuICAgICAgbWF4ID0gdmFsO1xuICAgICAgLy8gdXBkYXRlIG1pbiBtYXhcbiAgICAgIC8vIDEuIFBpY2sgMiBlbGVtZW50cyhhLCBiKSwgY29tcGFyZSB0aGVtLiAoc2F5IGEgPiBiKVxuICAgICAgbWluID0gTWF0aC5taW4obWluLCBtYXgpO1xuICAgICAgbWF4ID0gTWF0aC5tYXgobWluLCBtYXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyAyLiBVcGRhdGUgbWluIGJ5IGNvbXBhcmluZyAobWluLCBiKVxuICAgICAgLy8gMy4gVXBkYXRlIG1heCBieSBjb21wYXJpbmcgKG1heCwgYSlcbiAgICAgIG1pbiA9IE1hdGgubWluKHZhbCwgbWluKTtcbiAgICAgIG1heCA9IE1hdGgubWF4KHZhbCwgbWF4KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIFttaW4sIG1heF07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc051bWJlcih2YWw6IGFueSk6IGJvb2xlYW4ge1xuICByZXR1cm4gdHlwZW9mIHZhbCA9PT0gJ251bWJlcicgJiYgIWlzTmFOKHZhbCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1ZhbGlkZSh2YWw6IGFueSk6IGJvb2xlYW4ge1xuICByZXR1cm4gdmFsICE9PSB1bmRlZmluZWQgJiYgdmFsICE9PSBudWxsICYmICFpc05hTih2YWwpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZFN0b3BMZXNzVGhhbk9yRXF1YWxUbyhzdG9wczogbnVtYmVyW10sIGlucHV0OiBudW1iZXIpIHtcbiAgY29uc3QgbGFzdEluZGV4ID0gc3RvcHMubGVuZ3RoIC0gMTtcbiAgbGV0IGxvd2VySW5kZXggPSAwO1xuICBsZXQgdXBwZXJJbmRleCA9IGxhc3RJbmRleDtcbiAgbGV0IGN1cnJlbnRJbmRleCA9IDA7XG4gIGxldCBjdXJyZW50VmFsdWU7XG4gIGxldCBuZXh0VmFsdWU7XG5cbiAgd2hpbGUgKGxvd2VySW5kZXggPD0gdXBwZXJJbmRleCkge1xuICAgIGN1cnJlbnRJbmRleCA9IE1hdGguZmxvb3IoKGxvd2VySW5kZXggKyB1cHBlckluZGV4KSAvIDIpO1xuICAgIGN1cnJlbnRWYWx1ZSA9IHN0b3BzW2N1cnJlbnRJbmRleF07XG4gICAgbmV4dFZhbHVlID0gc3RvcHNbY3VycmVudEluZGV4ICsgMV07XG5cbiAgICBpZiAoY3VycmVudFZhbHVlIDw9IGlucHV0KSB7XG4gICAgICBpZiAoY3VycmVudEluZGV4ID09PSBsYXN0SW5kZXggfHwgaW5wdXQgPCBuZXh0VmFsdWUpIHtcbiAgICAgICAgLy8gU2VhcmNoIGNvbXBsZXRlXG4gICAgICAgIHJldHVybiBjdXJyZW50SW5kZXg7XG4gICAgICB9XG5cbiAgICAgIGxvd2VySW5kZXggPSBjdXJyZW50SW5kZXggKyAxO1xuICAgIH0gZWxzZSBpZiAoY3VycmVudFZhbHVlID4gaW5wdXQpIHtcbiAgICAgIHVwcGVySW5kZXggPSBjdXJyZW50SW5kZXggLSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0lucHV0IGlzIG5vdCBhIG51bWJlci4nKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gMDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZwNjRMb3dQYXJ0KHg6IG51bWJlcikge1xuICByZXR1cm4geCAtIE1hdGguZnJvdW5kKHgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWF0NEludmVydChvdXQ6IG51bWJlcltdLCBhOiBudW1iZXJbXSkge1xuICBjb25zdCBhMDAgPSBhWzBdO1xuICBjb25zdCBhMDEgPSBhWzFdO1xuICBjb25zdCBhMDIgPSBhWzJdO1xuICBjb25zdCBhMDMgPSBhWzNdO1xuICBjb25zdCBhMTAgPSBhWzRdO1xuICBjb25zdCBhMTEgPSBhWzVdO1xuICBjb25zdCBhMTIgPSBhWzZdO1xuICBjb25zdCBhMTMgPSBhWzddO1xuICBjb25zdCBhMjAgPSBhWzhdO1xuICBjb25zdCBhMjEgPSBhWzldO1xuICBjb25zdCBhMjIgPSBhWzEwXTtcbiAgY29uc3QgYTIzID0gYVsxMV07XG4gIGNvbnN0IGEzMCA9IGFbMTJdO1xuICBjb25zdCBhMzEgPSBhWzEzXTtcbiAgY29uc3QgYTMyID0gYVsxNF07XG4gIGNvbnN0IGEzMyA9IGFbMTVdO1xuXG4gIGNvbnN0IGIwMCA9IGEwMCAqIGExMSAtIGEwMSAqIGExMDtcbiAgY29uc3QgYjAxID0gYTAwICogYTEyIC0gYTAyICogYTEwO1xuICBjb25zdCBiMDIgPSBhMDAgKiBhMTMgLSBhMDMgKiBhMTA7XG4gIGNvbnN0IGIwMyA9IGEwMSAqIGExMiAtIGEwMiAqIGExMTtcbiAgY29uc3QgYjA0ID0gYTAxICogYTEzIC0gYTAzICogYTExO1xuICBjb25zdCBiMDUgPSBhMDIgKiBhMTMgLSBhMDMgKiBhMTI7XG4gIGNvbnN0IGIwNiA9IGEyMCAqIGEzMSAtIGEyMSAqIGEzMDtcbiAgY29uc3QgYjA3ID0gYTIwICogYTMyIC0gYTIyICogYTMwO1xuICBjb25zdCBiMDggPSBhMjAgKiBhMzMgLSBhMjMgKiBhMzA7XG4gIGNvbnN0IGIwOSA9IGEyMSAqIGEzMiAtIGEyMiAqIGEzMTtcbiAgY29uc3QgYjEwID0gYTIxICogYTMzIC0gYTIzICogYTMxO1xuICBjb25zdCBiMTEgPSBhMjIgKiBhMzMgLSBhMjMgKiBhMzI7XG5cbiAgLy8gQ2FsY3VsYXRlIHRoZSBkZXRlcm1pbmFudFxuICBsZXQgZGV0ID1cbiAgICBiMDAgKiBiMTEgLSBiMDEgKiBiMTAgKyBiMDIgKiBiMDkgKyBiMDMgKiBiMDggLSBiMDQgKiBiMDcgKyBiMDUgKiBiMDY7XG5cbiAgaWYgKCFkZXQpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBkZXQgPSAxLjAgLyBkZXQ7XG5cbiAgb3V0WzBdID0gKGExMSAqIGIxMSAtIGExMiAqIGIxMCArIGExMyAqIGIwOSkgKiBkZXQ7XG4gIG91dFsxXSA9IChhMDIgKiBiMTAgLSBhMDEgKiBiMTEgLSBhMDMgKiBiMDkpICogZGV0O1xuICBvdXRbMl0gPSAoYTMxICogYjA1IC0gYTMyICogYjA0ICsgYTMzICogYjAzKSAqIGRldDtcbiAgb3V0WzNdID0gKGEyMiAqIGIwNCAtIGEyMSAqIGIwNSAtIGEyMyAqIGIwMykgKiBkZXQ7XG4gIG91dFs0XSA9IChhMTIgKiBiMDggLSBhMTAgKiBiMTEgLSBhMTMgKiBiMDcpICogZGV0O1xuICBvdXRbNV0gPSAoYTAwICogYjExIC0gYTAyICogYjA4ICsgYTAzICogYjA3KSAqIGRldDtcbiAgb3V0WzZdID0gKGEzMiAqIGIwMiAtIGEzMCAqIGIwNSAtIGEzMyAqIGIwMSkgKiBkZXQ7XG4gIG91dFs3XSA9IChhMjAgKiBiMDUgLSBhMjIgKiBiMDIgKyBhMjMgKiBiMDEpICogZGV0O1xuICBvdXRbOF0gPSAoYTEwICogYjEwIC0gYTExICogYjA4ICsgYTEzICogYjA2KSAqIGRldDtcbiAgb3V0WzldID0gKGEwMSAqIGIwOCAtIGEwMCAqIGIxMCAtIGEwMyAqIGIwNikgKiBkZXQ7XG4gIG91dFsxMF0gPSAoYTMwICogYjA0IC0gYTMxICogYjAyICsgYTMzICogYjAwKSAqIGRldDtcbiAgb3V0WzExXSA9IChhMjEgKiBiMDIgLSBhMjAgKiBiMDQgLSBhMjMgKiBiMDApICogZGV0O1xuICBvdXRbMTJdID0gKGExMSAqIGIwNyAtIGExMCAqIGIwOSAtIGExMiAqIGIwNikgKiBkZXQ7XG4gIG91dFsxM10gPSAoYTAwICogYjA5IC0gYTAxICogYjA3ICsgYTAyICogYjA2KSAqIGRldDtcbiAgb3V0WzE0XSA9IChhMzEgKiBiMDEgLSBhMzAgKiBiMDMgLSBhMzIgKiBiMDApICogZGV0O1xuICBvdXRbMTVdID0gKGEyMCAqIGIwMyAtIGEyMSAqIGIwMSArIGEyMiAqIGIwMCkgKiBkZXQ7XG5cbiAgcmV0dXJuIG91dDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRyYW5zZm9ybU1hdDQob3V0OiBudW1iZXJbXSwgYTogbnVtYmVyW10sIG06IG51bWJlcltdKSB7XG4gIGNvbnN0IHggPSBhWzBdO1xuICBjb25zdCB5ID0gYVsxXTtcbiAgY29uc3QgeiA9IGFbMl07XG4gIGNvbnN0IHcgPSBhWzNdO1xuICBvdXRbMF0gPSBtWzBdICogeCArIG1bNF0gKiB5ICsgbVs4XSAqIHogKyBtWzEyXSAqIHc7IC8vIDBcbiAgb3V0WzFdID0gbVsxXSAqIHggKyBtWzVdICogeSArIG1bOV0gKiB6ICsgbVsxM10gKiB3OyAvLyAwXG4gIG91dFsyXSA9IG1bMl0gKiB4ICsgbVs2XSAqIHkgKyBtWzEwXSAqIHogKyBtWzE0XSAqIHc7IC8vIDBcbiAgb3V0WzNdID0gbVszXSAqIHggKyBtWzddICogeSArIG1bMTFdICogeiArIG1bMTVdICogdzsgLy8gMVxuICByZXR1cm4gb3V0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RXllKG1hdHJpeDogbnVtYmVyW10pIHtcbiAgY29uc3QgZGVmYXVsdE1hdDQgPSBbMSwgMCwgMCwgMCwgMCwgMSwgMCwgMCwgMCwgMCwgMSwgMCwgMCwgMCwgMCwgMV07IC8vIGluc3RlZCBvZiBtYXQ0LmNyZWF0ZSgpXG4gIGxldCBleWUgPSB0cmFuc2Zvcm1NYXQ0KFxuICAgIFtdLFxuICAgIFswLCAwLCAwLCAxXSxcbiAgICBtYXQ0SW52ZXJ0KGRlZmF1bHRNYXQ0LCBtYXRyaXgpIGFzIG51bWJlcltdLFxuICApO1xuICBjb25zdCBjbGlwVyA9IDEuMCAvIGV5ZVszXTtcbiAgZXllID0gZXllLm1hcCgoaXRlbTogbnVtYmVyKSA9PiBpdGVtIC8gZXllWzNdKTtcbiAgZXllWzNdID0gY2xpcFc7XG4gIHJldHVybiBleWU7XG59XG4iLCJpbXBvcnQgeyBjYWxjTWluTWF4IH0gZnJvbSAnLi4vdXRpbHMvY29tbW9uJztcblxuY29uc3QgY3R4OiBXb3JrZXIgPSBzZWxmIGFzIGFueTtcblxuY3R4LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBhc3luYyAoeyBkYXRhOiBwYXlsb2FkIH0pID0+IHtcbiAgY29uc3QgcmVuZGVyRm9ybSA9IHBheWxvYWRbMF07XG4gIGlmIChyZW5kZXJGb3JtID09PSAncmcnKSB7XG4gICAgY29uc3QgdURhdGEgPSBwYXlsb2FkWzFdO1xuICAgIGNvbnN0IHZEYXRhID0gcGF5bG9hZFsyXTtcbiAgICBjb25zdCBbdU1pbiwgdU1heF0gPSBjYWxjTWluTWF4KHVEYXRhKTtcbiAgICBjb25zdCBbdk1pbiwgdk1heF0gPSBjYWxjTWluTWF4KHZEYXRhKTtcbiAgICBjb25zdCB2ZWxvY2l0eURhdGEgPSBuZXcgVWludDhBcnJheSh1RGF0YS5sZW5ndGggKiA0KTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVEYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCByID0gMjU1ICogKHVEYXRhW2ldIC0gdU1pbikgLyAodU1heCAtIHVNaW4pO1xuICAgICAgY29uc3QgZyA9IDI1NSAqICh2RGF0YVtpXSAtIHZNaW4pIC8gKHZNYXggLSB2TWluKTtcbiAgICAgIHZlbG9jaXR5RGF0YS5zZXQoW3IsIGcsIDAsIDI1NV0sIGkgKiA0KTtcbiAgICB9XG5cbiAgICBjdHgucG9zdE1lc3NhZ2UoW3ZlbG9jaXR5RGF0YS5idWZmZXIsIHVNaW4sIHVNYXgsIHZNaW4sIHZNYXhdLCBbdmVsb2NpdHlEYXRhLmJ1ZmZlcl0pO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHNpbmdsZURhdGEgPSBwYXlsb2FkWzFdO1xuICAgIGNvbnN0IFttaW4sIG1heF0gPSBjYWxjTWluTWF4KHNpbmdsZURhdGEpO1xuICAgIGNvbnN0IHZlbG9jaXR5RGF0YSA9IG5ldyBVaW50OEFycmF5KHNpbmdsZURhdGEubGVuZ3RoICogNCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaW5nbGVEYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCByID0gMjU1ICogKHNpbmdsZURhdGFbaV0gLSBtaW4pIC8gKG1heCAtIG1pbik7XG4gICAgICB2ZWxvY2l0eURhdGEuc2V0KFtyLCAwLCAwLCAyNTVdLCBpICogNCk7XG4gICAgfVxuXG4gICAgY3R4LnBvc3RNZXNzYWdlKFt2ZWxvY2l0eURhdGEuYnVmZmVyLCBtaW4sIG1heF0sIFt2ZWxvY2l0eURhdGEuYnVmZmVyXSk7XG4gIH1cbn0pO1xuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztFQUFPLFNBQVMsV0FBVyxLQUFtQyxFQUFBO0VBQzVELEVBQUEsSUFBSSxHQUFNLEdBQUEsUUFBQSxDQUFBO0VBQ1YsRUFBQSxJQUFJLEdBQU0sR0FBQSxRQUFBLENBQUE7RUFFVixFQUFBLEtBQUEsSUFBUyxDQUFJLEdBQUEsQ0FBQSxFQUFHLENBQUksR0FBQSxLQUFBLENBQU0sUUFBUSxDQUFLLEVBQUEsRUFBQTtFQUNyQyxJQUFBLE1BQU0sTUFBTSxLQUFNLENBQUEsQ0FBQSxDQUFBLENBQUE7RUFFbEIsSUFBQSxJQUFJLFFBQVEsUUFBVSxFQUFBO0VBQ3BCLE1BQU0sR0FBQSxHQUFBLEdBQUEsQ0FBQTtFQUFBLEtBQ1IsTUFBQSxJQUFXLFFBQVEsUUFBVSxFQUFBO0VBQzNCLE1BQU0sR0FBQSxHQUFBLEdBQUEsQ0FBQTtFQUdOLE1BQU0sR0FBQSxHQUFBLElBQUEsQ0FBSyxHQUFJLENBQUEsR0FBQSxFQUFLLEdBQUcsQ0FBQSxDQUFBO0VBQ3ZCLE1BQU0sR0FBQSxHQUFBLElBQUEsQ0FBSyxHQUFJLENBQUEsR0FBQSxFQUFLLEdBQUcsQ0FBQSxDQUFBO0VBQUEsS0FDbEIsTUFBQTtFQUdMLE1BQU0sR0FBQSxHQUFBLElBQUEsQ0FBSyxHQUFJLENBQUEsR0FBQSxFQUFLLEdBQUcsQ0FBQSxDQUFBO0VBQ3ZCLE1BQU0sR0FBQSxHQUFBLElBQUEsQ0FBSyxHQUFJLENBQUEsR0FBQSxFQUFLLEdBQUcsQ0FBQSxDQUFBO0VBQUEsS0FDekI7RUFBQSxHQUNGO0VBQ0EsRUFBTyxPQUFBLENBQUMsS0FBSyxHQUFHLENBQUEsQ0FBQTtFQUNsQjs7RUNyQkEsTUFBTSxHQUFjLEdBQUEsSUFBQSxDQUFBO0VBRXBCLEdBQUEsQ0FBSSxpQkFBaUIsU0FBVyxFQUFBLE9BQU8sRUFBRSxJQUFBLEVBQU0sU0FBYyxLQUFBO0VBQzNELEVBQUEsTUFBTSxhQUFhLE9BQVEsQ0FBQSxDQUFBLENBQUEsQ0FBQTtFQUMzQixFQUFBLElBQUksZUFBZSxJQUFNLEVBQUE7RUFDdkIsSUFBQSxNQUFNLFFBQVEsT0FBUSxDQUFBLENBQUEsQ0FBQSxDQUFBO0VBQ3RCLElBQUEsTUFBTSxRQUFRLE9BQVEsQ0FBQSxDQUFBLENBQUEsQ0FBQTtFQUN0QixJQUFBLE1BQU0sQ0FBQyxJQUFBLEVBQU0sSUFBSSxDQUFBLEdBQUksV0FBVyxLQUFLLENBQUEsQ0FBQTtFQUNyQyxJQUFBLE1BQU0sQ0FBQyxJQUFBLEVBQU0sSUFBSSxDQUFBLEdBQUksV0FBVyxLQUFLLENBQUEsQ0FBQTtFQUNyQyxJQUFBLE1BQU0sWUFBZSxHQUFBLElBQUksVUFBVyxDQUFBLEtBQUEsQ0FBTSxTQUFTLENBQUMsQ0FBQSxDQUFBO0VBQ3BELElBQUEsS0FBQSxJQUFTLENBQUksR0FBQSxDQUFBLEVBQUcsQ0FBSSxHQUFBLEtBQUEsQ0FBTSxRQUFRLENBQUssRUFBQSxFQUFBO0VBQ3JDLE1BQUEsTUFBTSxDQUFJLEdBQUEsR0FBQSxJQUFPLEtBQU0sQ0FBQSxDQUFBLENBQUEsR0FBSyxTQUFTLElBQU8sR0FBQSxJQUFBLENBQUEsQ0FBQTtFQUM1QyxNQUFBLE1BQU0sQ0FBSSxHQUFBLEdBQUEsSUFBTyxLQUFNLENBQUEsQ0FBQSxDQUFBLEdBQUssU0FBUyxJQUFPLEdBQUEsSUFBQSxDQUFBLENBQUE7RUFDNUMsTUFBYSxZQUFBLENBQUEsR0FBQSxDQUFJLENBQUMsQ0FBRyxFQUFBLENBQUEsRUFBRyxHQUFHLEdBQUcsQ0FBQSxFQUFHLElBQUksQ0FBQyxDQUFBLENBQUE7RUFBQSxLQUN4QztFQUVBLElBQUEsR0FBQSxDQUFJLFdBQVksQ0FBQSxDQUFDLFlBQWEsQ0FBQSxNQUFBLEVBQVEsSUFBTSxFQUFBLElBQUEsRUFBTSxJQUFNLEVBQUEsSUFBSSxDQUFHLEVBQUEsQ0FBQyxZQUFhLENBQUEsTUFBTSxDQUFDLENBQUEsQ0FBQTtFQUFBLEdBQy9FLE1BQUE7RUFDTCxJQUFBLE1BQU0sYUFBYSxPQUFRLENBQUEsQ0FBQSxDQUFBLENBQUE7RUFDM0IsSUFBQSxNQUFNLENBQUMsR0FBQSxFQUFLLEdBQUcsQ0FBQSxHQUFJLFdBQVcsVUFBVSxDQUFBLENBQUE7RUFDeEMsSUFBQSxNQUFNLFlBQWUsR0FBQSxJQUFJLFVBQVcsQ0FBQSxVQUFBLENBQVcsU0FBUyxDQUFDLENBQUEsQ0FBQTtFQUN6RCxJQUFBLEtBQUEsSUFBUyxDQUFJLEdBQUEsQ0FBQSxFQUFHLENBQUksR0FBQSxVQUFBLENBQVcsUUFBUSxDQUFLLEVBQUEsRUFBQTtFQUMxQyxNQUFBLE1BQU0sQ0FBSSxHQUFBLEdBQUEsSUFBTyxVQUFXLENBQUEsQ0FBQSxDQUFBLEdBQUssUUFBUSxHQUFNLEdBQUEsR0FBQSxDQUFBLENBQUE7RUFDL0MsTUFBYSxZQUFBLENBQUEsR0FBQSxDQUFJLENBQUMsQ0FBRyxFQUFBLENBQUEsRUFBRyxHQUFHLEdBQUcsQ0FBQSxFQUFHLElBQUksQ0FBQyxDQUFBLENBQUE7RUFBQSxLQUN4QztFQUVBLElBQUksR0FBQSxDQUFBLFdBQUEsQ0FBWSxDQUFDLFlBQUEsQ0FBYSxNQUFRLEVBQUEsR0FBQSxFQUFLLEdBQUcsQ0FBRyxFQUFBLENBQUMsWUFBYSxDQUFBLE1BQU0sQ0FBQyxDQUFBLENBQUE7RUFBQSxHQUN4RTtFQUNGLENBQUMsQ0FBQTs7Ozs7OyJ9",!1);function P(s){return typeof s=="number"&&!isNaN(s)}function Tt(s,t){const e=s.length-1;let i=0,r=e,o=0,n,a;for(;i<=r;)if(o=Math.floor((i+r)/2),n=s[o],a=s[o+1],n<=t){if(o===e||t<a)return o;i=o+1}else if(n>t)r=o-1;else throw new Error("Input is not a number.");return 0}function Z(s){return s-Math.fround(s)}function Ut(s,t){const e=t[0],i=t[1],r=t[2],o=t[3],n=t[4],a=t[5],c=t[6],l=t[7],h=t[8],u=t[9],d=t[10],f=t[11],_=t[12],S=t[13],m=t[14],y=t[15],C=e*a-i*n,F=e*c-r*n,U=e*l-o*n,g=i*c-r*a,v=i*l-o*a,B=r*l-o*c,I=h*S-u*_,b=h*m-d*_,E=h*y-f*_,M=u*m-d*S,L=u*y-f*S,D=d*y-f*m;let p=C*D-F*L+U*M+g*E-v*b+B*I;return p?(p=1/p,s[0]=(a*D-c*L+l*M)*p,s[1]=(r*L-i*D-o*M)*p,s[2]=(S*B-m*v+y*g)*p,s[3]=(d*v-u*B-f*g)*p,s[4]=(c*E-n*D-l*b)*p,s[5]=(e*D-r*E+o*b)*p,s[6]=(m*U-_*B-y*F)*p,s[7]=(h*B-d*U+f*F)*p,s[8]=(n*L-a*E+l*I)*p,s[9]=(i*E-e*L-o*I)*p,s[10]=(_*v-S*U+y*C)*p,s[11]=(u*U-h*v-f*C)*p,s[12]=(a*b-n*M-c*I)*p,s[13]=(e*M-i*b+r*I)*p,s[14]=(S*F-_*g-m*C)*p,s[15]=(h*g-u*F+d*C)*p,s):null}function Rt(s,t,e){const i=t[0],r=t[1],o=t[2],n=t[3];return s[0]=e[0]*i+e[4]*r+e[8]*o+e[12]*n,s[1]=e[1]*i+e[5]*r+e[9]*o+e[13]*n,s[2]=e[2]*i+e[6]*r+e[10]*o+e[14]*n,s[3]=e[3]*i+e[7]*r+e[11]*o+e[15]*n,s}function Gt(s){let e=Rt([],[0,0,0,1],Ut([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s));const i=1/e[3];return e=e.map(r=>r/e[3]),e[3]=i,e}function Mt(){return devicePixelRatio||1}function Lt(s,t){if(!s)return!1;if(t=t||Mt(),s instanceof HTMLCanvasElement){const e=s.clientWidth*t,i=s.clientHeight*t;if(e<=0||i<=0)return!1;if(s.width!==e||s.height!==i)return s.width=e,s.height=i,!0}return!1}function Dt(s,t={}){return Object.keys(t).map(e=>{t[e]&&(s=s.replace(new RegExp(e,"g"),`${t[e]} 
`))}),s}function J(s,t,e){const i=s.createShader(t);if(s.shaderSource(i,e),s.compileShader(i),!s.getShaderParameter(i,s.COMPILE_STATUS)){const r=s.getShaderInfoLog(i)||"";throw s.deleteShader(i),new Error(r)}return i}function Wt(s,t,e){const i=J(s,s.VERTEX_SHADER,t),r=J(s,s.FRAGMENT_SHADER,e),o=s.createProgram();if(o!==null&&(s.attachShader(o,i),s.attachShader(o,r),s.linkProgram(o),!s.getProgramParameter(o,s.LINK_STATUS)))throw new Error(s.getProgramInfoLog(o)||"");return o}function w(s,t,e,i,r){const o=s.createTexture();return s.bindTexture(s.TEXTURE_2D,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,t),e instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,0,s.RGBA,i,r,0,s.RGBA,s.UNSIGNED_BYTE,e):s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,e),s.bindTexture(s.TEXTURE_2D,null),o}function V(s,t,e,i,r){s.bindTexture(s.TEXTURE_2D,t),r instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,0,s.RGBA,e,i,0,s.RGBA,s.UNSIGNED_BYTE,r):s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,r),s.bindTexture(s.TEXTURE_2D,null)}function Q(s,t){const e=s.createBuffer();return s.bindBuffer(s.ARRAY_BUFFER,e),t&&s.bufferData(s.ARRAY_BUFFER,t,s.STATIC_DRAW),e}function Xt(s,t,e){return s.bindBuffer(s.ARRAY_BUFFER,t),e&&s.bufferData(s.ARRAY_BUFFER,e,s.STATIC_DRAW),t}function Y(s,t,e){s.bindFramebuffer(s.FRAMEBUFFER,t),e&&s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,e,0)}function Vt(s,t,e,i,r){s.bindFramebuffer(s.FRAMEBUFFER,t),r&&s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,r,0)}function z(s,t,e=1,i=0,r){const[o,n,a,c]=t;let l=0;s.clearColor(o,n,a,c),l|=s.COLOR_BUFFER_BIT,e!==void 0&&(s.clearDepth(e),l|=s.DEPTH_BUFFER_BIT),i!==void 0&&(s.clearStencil(i|0),l|=s.STENCIL_BUFFER_BIT),s.clear(l)}function ht(s){return new Promise((t,e)=>{s||e(new Event("url is null"));const i=new Image;i.crossOrigin="anonymous",i.onload=()=>t(i),i.onerror=e,i.src=s,i.complete&&t(i)})}function Nt(s,t,e,i,r,o){const n=t-s,a=i-e,c=n/2,l=a/2,h=Math.floor(r),u=Math.floor(o),d=h+1,f=u+1,_=n/h,S=a/u,m=[],y=[],C=[],F=[],U=[];for(let g=0;g<f;g++){const v=g*S;for(let B=0;B<d;B++){const I=B*_,b=s+I/c/2*n,E=e+v/l/2*a;C.push(b,E,0),F.push(Z(b),Z(E),0),U.push(B/h,g/u)}}for(let g=0;g<u;g++)for(let v=0;v<h;v++){const B=v+d*g,I=v+d*(g+1),b=v+1+d*(g+1),E=v+1+d*g;m.push(B,I,E),m.push(I,b,E)}for(let g=0,v=m.length;g<v;g+=3){const B=m[g],I=m[g+1],b=m[g+2];y.push(B,I,I,b,b,B)}return{uvs:{data:U,size:2},elements:{data:m,count:m.length},wireframeElements:{data:y,count:y.length},position:{data:C,size:3},positionLow:{data:F,size:3}}}class X{constructor(t,e,i,r){this.vertShader="",this.fragShader="",e&&(this.vertShader=e),i&&(this.fragShader=i),this.program=Wt(t,Dt(this.vertShader,r),this.fragShader),this.gl=t,this.textureUnit=0,this.uniformSetters=this.createUniformSetters(),this.attribSetters=this.createAttributeSetters(),this.transfromStack=[]}active(){return this.gl.useProgram(this.program),this}deactive(){return this.gl.deleteProgram(this.program),this}getBindPointForSamplerType(t,e){if(e===t.SAMPLER_2D)return t.TEXTURE_2D;if(e===t.SAMPLER_CUBE)return t.TEXTURE_CUBE_MAP}createUniformSetter(t,e){const{gl:i}=this,r=i.getUniformLocation(t,e.name),o=e.type,n=e.size>1&&e.name.substr(-3)==="[0]";if(o===i.FLOAT&&n)return function(a){i.uniform1fv(r,a)};if(o===i.FLOAT)return function(a){i.uniform1f(r,a)};if(o===i.FLOAT_VEC2)return function(a){i.uniform2fv(r,a)};if(o===i.FLOAT_VEC3)return function(a){i.uniform3fv(r,a)};if(o===i.FLOAT_VEC4)return function(a){i.uniform4fv(r,a)};if(o===i.INT&&n)return function(a){i.uniform1iv(r,a)};if(o===i.INT)return function(a){i.uniform1i(r,a)};if(o===i.INT_VEC2)return function(a){i.uniform2iv(r,a)};if(o===i.INT_VEC3)return function(a){i.uniform3iv(r,a)};if(o===i.INT_VEC4)return function(a){i.uniform4iv(r,a)};if(o===i.BOOL)return function(a){i.uniform1iv(r,a)};if(o===i.BOOL_VEC2)return function(a){i.uniform2iv(r,a)};if(o===i.BOOL_VEC3)return function(a){i.uniform3iv(r,a)};if(o===i.BOOL_VEC4)return function(a){i.uniform4iv(r,a)};if(o===i.FLOAT_MAT2)return function(a){i.uniformMatrix2fv(r,!1,a)};if(o===i.FLOAT_MAT3)return function(a){i.uniformMatrix3fv(r,!1,a)};if(o===i.FLOAT_MAT4)return function(a){i.uniformMatrix4fv(r,!1,a)};if((o===i.SAMPLER_2D||o===i.SAMPLER_CUBE)&&n){const a=[];for(let c=0;c<e.size;++c)a.push(this.textureUnit++);return function(c,l){return function(h){i.uniform1iv(r,l),h.forEach(function(u,d){i.activeTexture(i.TEXTURE0+l[d]),c!==void 0&&i.bindTexture(c,u)})}}(this.getBindPointForSamplerType(i,o),a)}if(o===i.SAMPLER_2D||o===i.SAMPLER_CUBE)return function(a,c){return function(l){i.uniform1i(r,c),i.activeTexture(i.TEXTURE0+c),a!==void 0&&i.bindTexture(a,l)}}(this.getBindPointForSamplerType(i,o),this.textureUnit++);throw new Error("unknown type: 0x"+o.toString(16))}createUniformSetters(){const{gl:t}=this;this.textureUnit=0;const e={};if(this.program!==null){const i=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS);for(let r=0;r<i;++r){const o=t.getActiveUniform(this.program,r);if(!o)break;let n=o.name;n.substr(-3)==="[0]"&&(n=n.substr(0,n.length-3));const a=this.createUniformSetter(this.program,o);e[n]=a}}return e}createAttribSetter(t){const{gl:e}=this;return function(i){e.bindBuffer(e.ARRAY_BUFFER,i.buffer),e.enableVertexAttribArray(t),(i.numComponents!==void 0||i.size!==void 0)&&e.vertexAttribPointer(t,i.numComponents||i.size,i.type||e.FLOAT,i.normalize||!1,i.stride||0,i.offset||0)}}createAttributeSetters(){const{gl:t}=this,e={};if(this.program!==null){const i=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);for(let r=0;r<i;++r){const o=t.getActiveAttrib(this.program,r);if(!o)break;const n=t.getAttribLocation(this.program,o.name);e[o.name]=this.createAttribSetter(n)}}return e}setAttributes(t,e){return e?e=e.attribSetters||e:e=this.attribSetters,Object.keys(t).forEach(function(i){const r=e[i];r&&r(t[i])}),this}setUniforms(t,e){return e?e=e.uniformSetters||e:e=this.uniformSetters,Object.keys(t).forEach(function(i){const r=e[i];r&&r(t[i])}),this}elements(t){return this.elementsBuffer||(this.elementsBuffer=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.elementsBuffer),t.data&&this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,t.data,t.usage||this.gl.STATIC_DRAW),t.count!==void 0&&this.runTimes(t.count),t.primitive&&this.setPrimitive(t.primitive),this}clear(t){return z(this.gl,t),this.transfromStack=[],this}runTimes(t){return this.count=t||0,this}setPrimitive(t){return this.primitive=t||this.gl.TRIANGLES,this}resize(t,e){return t===void 0||e===void 0?(Lt(this.gl.canvas),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)):this.gl.viewport(0,0,t,e),this}draw(){throw new Error("should override")}translate(){throw new Error("should override")}rotate(){throw new Error("should override")}scale(){throw new Error("should override")}destroyed(){throw new Error("should override")}}var q=`precision highp float;
#define GLSLIFY 1
uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform vec2 u_image_res;uniform vec2 u_range;uniform vec2 u_color_range;uniform vec2 u_display_range;uniform float u_opacity;varying vec2 v_tex_pos;float calcTexture(const vec2 uv){return texture2D(u_image,uv).r;}float bilinear(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=calcTexture(vc);float tr=calcTexture(vc+vec2(px.x,0));float bl=calcTexture(vc+vec2(0,px.y));float br=calcTexture(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float getValue(const vec2 uv){float min=u_range.x;float max=u_range.y;float r=bilinear(uv);return r*(max-min)+min;}const float PI=3.14159265359;vec2 mercatorToWGS84(vec2 xy){float y=radians(180.0-xy.y*360.0);y=360.0/PI*atan(exp(y))-90.0;y=y/-180.0+0.5;return vec2(xy.x,y);}void main(){vec2 globalWGS84=mercatorToWGS84(v_tex_pos);float value=getValue(globalWGS84);float value_t=(value-u_color_range.x)/(u_color_range.y-u_color_range.x);vec2 ramp_pos=vec2(fract(16.0*value_t),floor(16.0*value_t)/16.0);vec4 color=texture2D(u_color_ramp,ramp_pos);bool display=value<u_display_range.y&&value>u_display_range.x;if(display){gl_FragColor=vec4(floor(255.0*color*u_opacity)/255.0);}else{gl_FragColor=vec4(0.0,0.0,0.0,0.0);}}`,$=`#define GLSLIFY 1
attribute vec3 instancePositions;attribute vec3 instancePositions64Low;attribute vec2 a_texCoord;uniform mat4 u_matrix;uniform vec4 u_cameraEye;uniform vec4 u_cameraEye64Low;uniform float u_offset;uniform sampler2D u_image;uniform vec2 u_image_res;uniform vec2 u_range;uniform vec2 u_mapping_range;varying vec2 v_tex_pos;varying float v_value;float calcTexture(const vec2 uv){return texture2D(u_image,uv).r;}float bilinear(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=calcTexture(vc);float tr=calcTexture(vc+vec2(px.x,0));float bl=calcTexture(vc+vec2(0,px.y));float br=calcTexture(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float getValue(const vec2 uv){float min=u_mapping_range.x;float max=u_mapping_range.y;float r=bilinear(uv);return r*(max-min)+min;}const float PI=3.14159265359;vec2 mercatorToWGS84(vec2 xy){float y=radians(180.0-xy.y*360.0);y=360.0/PI*atan(exp(y))-90.0;y=y/-180.0+0.5;return vec2(xy.x,y);}
#modules-transformZ
void main(){v_tex_pos=a_texCoord;vec2 globalWGS84=mercatorToWGS84(v_tex_pos);float value=getValue(globalWGS84);float z=transformZ(value,instancePositions);vec4 pos=vec4(instancePositions-u_cameraEye.xyz,0.0);pos+=vec4(instancePositions64Low-u_cameraEye64Low.xyz,0.0);
#modules-project
}`;class Yt extends X{constructor(t,e,i,r){super(t,e||$,i||q,r||{}),this.vertShader=$,this.fragShader=q}draw(){if(this.checkExt!==void 0){const t=this.primitive||this.gl.TRIANGLES;this.checkExt?this.gl.drawElements(t,this.count,this.gl.UNSIGNED_INT,0):this.gl.drawElements(t,this.count,this.gl.UNSIGNED_SHORT,0)}else this.checkExt=this.gl.getExtension("OES_element_index_uint");return this}translate(){return this}rotate(){return this}scale(){return this}}function Pt(s){if(Array.isArray(s)&&s.length>3){const t=s[0],e=s[1],i=[];for(let r=3;r<s.length;r+=2){const o=s[r],n=s[r+1];i.push({key:o,value:n})}return{operator:t,interpolation:{name:e[0],base:e[1]},input:i}}else return console.warn("[wind-core]: style-parser style config invalid"),{}}function Zt(s){if(Array.isArray(s)&&s.length>3){const t=s[0],e=s[1],i=[];for(let r=3;r<s.length;r+=2){const o=s[r],n=s[r+1];i.push({key:o,value:n})}return{operator:t,interpolation:{name:e[0],base:e[1]},input:i}}else return console.warn("[wind-core]: style-parser style config invalid"),{}}function ut(s,t){const e=document.createElement("canvas"),i=e.getContext("2d");e.width=256,e.height=1;const{input:r}=Pt(t);if(i&&r&&Array.isArray(r)){const o=r.map(h=>parseFloat(h.key)),n=[Math.min(...o),Math.max(...o)],[a,c]=[s[0]||n[0],s[1]||n[1]],l=i.createLinearGradient(0,0,256,0);for(let h=0;h<r.length;h+=1){const u=r[h].key,d=r[h].value;l.addColorStop((u-a)/(c-a),d)}return i.fillStyle=l,i.fillRect(0,0,256,1),{data:new Uint8Array(i.getImageData(0,0,256,1).data),colorRange:n}}else return{}}function tt(s,t,e,i){const r=i-e,o=s-e;return r===0?0:t===1?o/r:(Math.pow(t,o)-1)/(Math.pow(t,r)-1)}function zt(s,t,e,i){let r=0;return s.name==="exponential"?r=tt(t,s.base,e,i):s.name==="linear"?r=tt(t,1,e,i):s.name==="cubic-bezier"&&console.warn("interpolationFactor"),r}function Ot(s,t,e){return s*(1-e)+t*e}const G={};function T(s,t,e,i,r){const o=`${s}_${e}`,n=i[e];if(P(n))return G[o]&&delete G[o],n;if(n&&Array.isArray(n)&&(!G[o]||r)&&(G[o]=Zt(n)),G[o]){const{input:a,interpolation:c}=G[o]||{};if(a&&Array.isArray(a)){const l=a.map(F=>F.key),h=a.map(F=>F.value);if(t<=l[0])return h[0];const u=l.length;if(t>=l[u-1])return h[u-1];const d=Tt(l,t),f=l.length-1,_=l[d],S=l[d>=f?f:d+1],m=zt(c,t,_,S),y=h[d],C=h[d>=f?f:d+1];return Ot(y,C,m)}else return 1}return 1}var et=`precision highp float;
#define GLSLIFY 1
uniform sampler2D u_wind;uniform sampler2D u_color_ramp;uniform vec2 u_image_res;uniform vec2 u_wind_min;uniform vec2 u_wind_max;uniform vec2 u_color_range;uniform vec2 u_display_range;uniform float u_opacity;varying vec2 v_tex_pos;vec2 windTexture(const vec2 uv){return texture2D(u_wind,uv).rg;}float bilinearU(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=windTexture(vc).r;float tr=windTexture(vc+vec2(px.x,0)).r;float bl=windTexture(vc+vec2(0,px.y)).r;float br=windTexture(vc+px).r;return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float bilinearV(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=windTexture(vc).g;float tr=windTexture(vc+vec2(px.x,0.0)).g;float bl=windTexture(vc+vec2(0.0,px.y)).g;float br=windTexture(vc+px).g;return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float getV(const vec2 uv){float min=u_wind_min.y;float max=u_wind_max.y;float r=bilinearV(uv);return r*(max-min)+min;}float getU(const vec2 uv){float min=u_wind_min.x;float max=u_wind_max.x;float r=bilinearU(uv);return r*(max-min)+min;}float windSpeed(const vec2 uv){float u=getU(uv);float v=getV(uv);return length(vec2(u,v));}const float PI=3.14159265359;vec2 mercatorToWGS84(vec2 xy){float y=radians(180.0-xy.y*360.0);y=360.0/PI*atan(exp(y))-90.0;y=y/-180.0+0.5;return vec2(xy.x,y);}void main(){vec2 globalWGS84=mercatorToWGS84(v_tex_pos);float value=windSpeed(globalWGS84);float value_t=(value-u_color_range.x)/(u_color_range.y-u_color_range.x);vec2 ramp_pos=vec2(fract(16.0*value_t),floor(16.0*value_t)/16.0);vec4 color=texture2D(u_color_ramp,ramp_pos);bool display=value<u_display_range.y&&value>u_display_range.x;if(display){gl_FragColor=vec4(floor(255.0*color*u_opacity)/255.0);}else{gl_FragColor=vec4(0.0,0.0,0.0,0.0);}}`,it=`#define GLSLIFY 1
attribute vec3 instancePositions;attribute vec3 instancePositions64Low;attribute vec2 a_texCoord;uniform mat4 u_matrix;uniform vec4 u_cameraEye;uniform vec4 u_cameraEye64Low;uniform float u_offset;uniform sampler2D u_wind;uniform vec2 u_image_res;uniform vec2 u_wind_min;uniform vec2 u_wind_max;uniform vec2 u_mapping_range;varying vec2 v_tex_pos;varying float v_value;vec2 windTexture(const vec2 uv){return texture2D(u_wind,uv).rg;}float bilinearU(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=windTexture(vc).r;float tr=windTexture(vc+vec2(px.x,0)).r;float bl=windTexture(vc+vec2(0,px.y)).r;float br=windTexture(vc+px).r;return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float bilinearV(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=windTexture(vc).g;float tr=windTexture(vc+vec2(px.x,0.0)).g;float bl=windTexture(vc+vec2(0.0,px.y)).g;float br=windTexture(vc+px).g;return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float getV(const vec2 uv){float min=u_wind_min.y;float max=u_wind_max.y;float r=bilinearV(uv);return r*(max-min)+min;}float getU(const vec2 uv){float min=u_wind_min.x;float max=u_wind_max.x;float r=bilinearU(uv);return r*(max-min)+min;}float windSpeed(const vec2 uv){float u=getU(uv);float v=getV(uv);float min=u_mapping_range.x;float max=u_mapping_range.y;float val=length(vec2(u,v));return val*(max-min)+min;}const float PI=3.14159265359;vec2 mercatorToWGS84(vec2 xy){float y=radians(180.0-xy.y*360.0);y=360.0/PI*atan(exp(y))-90.0;y=y/-180.0+0.5;return vec2(xy.x,y);}
#modules-transformZ
void main(){v_tex_pos=a_texCoord;vec2 globalWGS84=mercatorToWGS84(v_tex_pos);float value=windSpeed(globalWGS84);float z=transformZ(value,instancePositions);vec4 pos=vec4(instancePositions-u_cameraEye.xyz,0.0);pos+=vec4(instancePositions64Low-u_cameraEye64Low.xyz,0.0);
#modules-project
}`;class kt extends X{constructor(t,e,i,r){super(t,e||it,i||et,r||{}),this.vertShader=it,this.fragShader=et}draw(){if(this.checkExt!==void 0){const t=this.primitive||this.gl.TRIANGLES;this.checkExt?this.gl.drawElements(t,this.count,this.gl.UNSIGNED_INT,0):this.gl.drawElements(t,this.count,this.gl.UNSIGNED_SHORT,0)}else this.checkExt=this.gl.getExtension("OES_element_index_uint");return this}translate(){return this}rotate(){return this}scale(){return this}destroyed(){}}const st={renderForm:"r",styleSpec:{"fill-color":["interpolate",["linear"],["get","value"],0,"#3288bd",10,"#66c2a5",20,"#abdda4",30,"#e6f598",40,"#fee08b",50,"#fdae61",60,"#f46d43",100,"#d53e4f"],opacity:1},displayRange:[1/0,1/0],mappingRange:[0,0],widthSegments:1,heightSegments:1,wireframe:!1,createPlaneBuffer:(s,t,e)=>{const[i,r,o,n]=[s[0][0],s[2][0],s[0][1],s[1][1]];return Nt(i,r,o,n,t,e)},injectShaderModules:{"#modules-transformZ":`
float transformZ(float value, vec3 pos) {
  return 0.0;
}
    `,"#modules-project":`
gl_Position = u_matrix * vec4(pos.xy + vec2(u_offset, 0.0), pos.z + z, 1.0);
    `}};let rt=0;class jt{constructor(t,e){if(this.gl=t,this.uid=`ScalarFill_${rt}`,rt++,!this.gl)throw new Error("initialize error");e||(e={}),this.options={...st,...e},this.opacity=this.options.opacity||1}updateOptions(t){this.options={...this.options,...t},this.buildColorRamp(),typeof this.options.getZoom=="function"&&this.setOpacity(T(this.uid,this.options.getZoom(),"opacity",this.options.styleSpec,!0))}setFillColor(){this.buildColorRamp()}setOpacity(t){this.opacity=t}handleZoom(){typeof this.options.getZoom=="function"&&this.setOpacity(T(this.uid,this.options.getZoom(),"opacity",this.options.styleSpec))}buildColorRamp(){var t;const{data:e,colorRange:i}=ut([],(t=this.options.styleSpec)==null?void 0:t["fill-color"]);i&&(this.colorRange=i),e&&(this.colorRampTexture=w(this.gl,this.gl.NEAREST,e,16,16))}initialize(t){this.drawCommand||(this.options.renderForm==="rg"?this.drawCommand=new kt(t,void 0,void 0,this.options.injectShaderModules):this.options.renderForm==="r"?this.drawCommand=new Yt(t,void 0,void 0,this.options.injectShaderModules):console.warn("This type is not supported temporarily")),this.buildColorRamp(),typeof this.options.getZoom=="function"&&this.setOpacity(T(this.uid,this.options.getZoom(),"opacity",this.options.styleSpec))}initializeVertex(t){let e=0;const i=t.length,r=[];for(;e<i;e++){const n=t[e],a=this.getMercatorCoordinate(n);r.push([a[0],a[1]])}const o=(this.options.createPlaneBuffer||st.createPlaneBuffer)(r,this.options.widthSegments||1,this.options.heightSegments||1);return{indexes:o.elements.data,wireframeIndexes:o.wireframeElements.data,quadBuffer:Q(this.gl,new Float32Array(o.position.data)),quad64LowBuffer:Q(this.gl,new Float32Array(o.positionLow.data)),texCoordBuffer:Q(this.gl,new Float32Array(o.uvs.data))}}getTextureData(t){return new Promise((e,i)=>{if(t.type==="image"&&t.url)ht(t.url).then(r=>{const o={width:r.width,height:r.height,texture:w(this.gl,this.gl.LINEAR,r,r.width,r.height),...this.initializeVertex(t.extent)};this.options.renderForm==="rg"?(o.uMin=t.uMin,o.uMax=t.uMax,o.vMin=t.vMin,o.vMax=t.vMax):this.options.renderForm==="r"?(o.min=t.min,o.max=t.max):console.warn("This type is not supported temporarily"),e(o)}).catch(r=>i(r));else if(t.type==="jsonArray"&&t.data){const r=t.data;let o;t.extent?o=t.extent:o=[[r[0].header.lo1,r[0].header.la1],[r[0].header.lo1,r[0].header.la2],[r[0].header.lo2,r[0].header.la1],[r[0].header.lo2,r[0].header.la2]];const n={width:r[0].header.nx,height:r[0].header.ny,...this.initializeVertex(o)};if(this.worker||(this.worker=new Qt,this.worker.addEventListener("message",({data:a})=>{this.options.renderForm==="rg"?(n.uMin=a[1],n.uMax=a[2],n.vMin=a[3],n.vMax=a[4],n.texture=w(this.gl,this.gl.LINEAR,new Uint8Array(a[0]),n.width,n.height)):this.options.renderForm==="r"?(n.min=a[1],n.max=a[2],n.texture=w(this.gl,this.gl.LINEAR,new Uint8Array(a[0]),n.width,n.height)):console.warn("This type is not supported temporarily"),e(n)})),this.options.renderForm==="rg"){let a,c;r.forEach(u=>{switch(u.header.parameterCategory+","+u.header.parameterNumber){case"1,2":case"2,2":a=u;break;case"1,3":case"2,3":c=u;break}});const l=new Float32Array(a.data),h=new Float32Array(c.data);this.worker.postMessage(["rg",l,h])}else if(this.options.renderForm==="r"){const a=new Float32Array(r[0].data);this.worker.postMessage(["r",a])}else console.warn("This type is not supported temporarily")}})}setData(t,e){this.gl&&t&&this.getTextureData(t).then(i=>{this.data=i,e&&e(!0),this.data&&this.initialize(this.gl),this.options.triggerRepaint&&(this.handleZoom(),this.options.triggerRepaint())}).catch(i=>{e&&e(!1),console.error(i)})}getData(){return this.data}getMercatorCoordinate([t,e]){return[t,e]}prerender(){}render(t,e,i){if(this.data&&this.drawCommand&&this.data.texture&&this.colorRampTexture){const r=this.opacity,o={u_opacity:P(r)?r:1,u_image_res:[this.data.width,this.data.height],u_matrix:t,u_offset:P(e)?e:0,u_color_ramp:this.colorRampTexture,u_color_range:this.colorRange,u_mapping_range:this.options.mappingRange||[0,0]};if(i&&(o.u_cameraEye=i.cameraEye,o.u_cameraEye64Low=i.cameraEye64Low),this.options.renderForm==="rg"){o.u_wind_min=[this.data.uMin,this.data.vMin],o.u_wind_max=[this.data.uMax,this.data.vMax],o.u_wind=this.data.texture;const c=[Math.sqrt(this.data.uMin*this.data.uMin+this.data.vMin*this.data.vMin),Math.sqrt(this.data.uMin*this.data.uMin+this.data.vMax*this.data.vMax),Math.sqrt(this.data.uMax*this.data.uMax+this.data.vMax*this.data.vMax),Math.sqrt(this.data.uMax*this.data.uMax+this.data.vMin*this.data.vMin)],l=0,h=Math.max(...c);o.u_display_range=this.options.displayRange||[l,h]}else this.options.renderForm==="r"?(o.u_range=[this.data.min,this.data.max],o.u_image=this.data.texture,o.u_display_range=this.options.displayRange||[o.u_range[0]-1,o.u_range[1]+1]):console.warn("This type is not supported temporarily");const n=this.gl.isEnabled(this.gl.DEPTH_TEST);this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthMask(!0),this.gl.depthFunc(this.gl.LEQUAL);const a=this.options.wireframe?this.data.wireframeIndexes:this.data.indexes;this.drawCommand.active().setUniforms(o).setAttributes({instancePositions:{buffer:this.data.quadBuffer,numComponents:3},instancePositions64Low:{buffer:this.data.quad64LowBuffer,numComponents:3},a_texCoord:{buffer:this.data.texCoordBuffer,numComponents:2}}).elements({data:new Uint32Array(a),primitive:this.options.wireframe?this.gl.LINES:this.gl.TRIANGLES,count:a==null?void 0:a.length,usage:this.gl.STATIC_DRAW}).draw(),n||this.gl.disable(this.gl.DEPTH_TEST)}}postrender(){}destroyData(){this.data}destroyed(){this.destroyData(),this.worker&&this.worker.terminate()}}var Ht=`precision highp float;
#define GLSLIFY 1
uniform sampler2D u_wind;uniform vec2 u_wind_res;uniform vec4 u_wind_range;uniform vec2 u_color_range;uniform sampler2D u_color_ramp;varying vec2 v_particle_pos;vec2 decodeValue(const vec2 uv){vec4 u_color=texture2D(u_wind,uv);float u=u_wind_range[0]+((u_wind_range[1]-u_wind_range[0])*(u_color.r*255.0-1.0))/254.0;float v=u_wind_range[2]+((u_wind_range[3]-u_wind_range[2])*(u_color.g*255.0-1.0))/254.0;return vec2(u,v);}vec2 lookup_wind(const vec2 uv){vec2 px=1.0/u_wind_res;vec2 vc=(floor(uv*u_wind_res))*px;vec2 f=fract(uv*u_wind_res);vec2 tl=decodeValue(vc);vec2 tr=decodeValue(vc+vec2(px.x,0));vec2 bl=decodeValue(vc+vec2(0,px.y));vec2 br=decodeValue(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}void main(){vec2 velocity=lookup_wind(v_particle_pos);float speed_t=length(velocity);float value_t=(speed_t-u_color_range.x)/(u_color_range.y-u_color_range.x);vec2 ramp_pos=vec2(fract(16.0*value_t),floor(16.0*value_t)/16.0);vec4 color=texture2D(u_color_ramp,ramp_pos);gl_FragColor=vec4(floor(255.0*color*color.a)/255.0);}`,Kt=`#define GLSLIFY 1
attribute float a_index;uniform sampler2D u_particles_current;uniform sampler2D u_particles_next;uniform float u_particles_res;uniform vec2 u_world;uniform float u_zoom;uniform vec4 u_bbox;uniform float u_offset;uniform float u_width;uniform float u_aspectRatio;uniform mat4 u_matrix;varying vec2 v_particle_pos;const vec2 bitEnc=vec2(1.0,255.0);const vec2 bitDec=1.0/bitEnc;vec2 fromRGBA(const vec4 color){vec4 rounded_color=floor(color*255.0+0.5)/255.0;float x=dot(rounded_color.rg,bitDec);float y=dot(rounded_color.ba,bitDec);return vec2(x,y);}vec4 buildOffset(vec2 perp){vec2 normal=perp*u_width;normal.x/=u_aspectRatio;return vec4(normal,0.0,0.0);}vec4 buildOffset(vec2 perp,vec2 scale){vec2 normal=perp/scale*u_width;normal.x/=u_aspectRatio;return vec4(normal,0.0,0.0);}vec4 getPosWithProject(vec2 current_pos,vec2 next_pos,float v_index){vec4 currentProjected=u_matrix*vec4(current_pos,0.0,1.0);vec4 nextProjected=u_matrix*vec4(next_pos,0.0,1.0);vec2 currentScreen=currentProjected.xy/currentProjected.w*u_world;vec2 nextScreen=nextProjected.xy/nextProjected.w*u_world;vec2 dir=normalize(nextScreen-currentScreen);vec2 perp=vec2(-dir.y,dir.x);float d=length(nextScreen-currentScreen);vec4 pos=currentProjected;if(a_index-v_index*6.0==0.0){pos=currentProjected+buildOffset(perp);}else if(a_index-v_index*6.0==1.0){pos=currentProjected-buildOffset(perp);}else if(a_index-v_index*6.0==2.0){pos=nextProjected+buildOffset(perp);}else if(a_index-v_index*6.0==3.0){pos=nextProjected+buildOffset(perp);}else if(a_index-v_index*6.0==4.0){pos=nextProjected-buildOffset(perp);}else if(a_index-v_index*6.0==5.0){pos=currentProjected-buildOffset(perp);}if(d>20.0||d<0.01){pos.xy+=u_world*pow(2.0,u_zoom+1.0);}return pos;}void main(){float v_index=floor(a_index/6.0);float ux=fract(v_index/u_particles_res);float vy=floor(v_index/u_particles_res)/u_particles_res;vec4 current_color=texture2D(u_particles_current,vec2(ux,vy));vec4 next_color=texture2D(u_particles_next,vec2(ux,vy));vec2 v_current_particle_pos=fromRGBA(current_color);vec2 v_next_particle_pos=fromRGBA(next_color);vec2 vc_pos=u_bbox.xy+v_current_particle_pos*(u_bbox.zw-u_bbox.xy);vec2 nc_pos=u_bbox.xy+v_next_particle_pos*(u_bbox.zw-u_bbox.xy);v_particle_pos=mix(vc_pos,nc_pos,0.5);v_current_particle_pos=clamp(vc_pos,0.0,1.0)+vec2(u_offset,0.0);v_next_particle_pos=clamp(nc_pos,0.0,1.0)+vec2(u_offset,0.0);gl_PointSize=1.0;gl_Position=getPosWithProject(v_current_particle_pos,v_next_particle_pos,v_index);}`,Jt=`precision highp float;
#define GLSLIFY 1
uniform sampler2D u_screen;uniform float u_opacity;uniform float u_fade;varying vec2 v_tex_pos;void main(){vec4 color=texture2D(u_screen,v_tex_pos);gl_FragColor=vec4(floor(255.0*color*u_opacity*u_fade)/255.0);}`,qt=`#define GLSLIFY 1
attribute vec2 a_pos;attribute vec2 a_tex_pos;varying vec2 v_tex_pos;void main(){v_tex_pos=a_tex_pos;gl_Position=vec4(a_pos*2.0-1.0,0,1);}`,$t=`precision highp float;
#define GLSLIFY 1
uniform sampler2D u_wind;uniform sampler2D u_particles;uniform vec4 u_bbox;uniform vec2 u_wind_res;uniform vec4 u_wind_range;uniform float u_rand_seed;uniform float u_nodata;uniform float u_drop_rate;uniform float u_drop_rate_bump;uniform vec2 u_speed_factor;varying vec2 v_tex_pos;const vec2 bitEnc_0=vec2(1.0,255.0);const vec2 bitDec_0=1.0/bitEnc_0;vec4 toRGBA(const vec2 pos_0){vec2 rg=bitEnc_0*pos_0.x;rg=fract(rg);rg-=rg.yy*vec2(1.0/255.0,0.0);vec2 ba=bitEnc_0*pos_0.y;ba=fract(ba);ba-=ba.yy*vec2(1.0/255.0,0.0);return vec4(rg,ba);}const vec2 bitEnc_1=vec2(1.0,255.0);const vec2 bitDec_1=1.0/bitEnc_1;vec2 fromRGBA(const vec4 color){vec4 rounded_color=floor(color*255.0+0.5)/255.0;float x=dot(rounded_color.rg,bitDec_1);float y=dot(rounded_color.ba,bitDec_1);return vec2(x,y);}const vec3 rand_constants=vec3(12.9898,78.233,4375.85453);float rand(const vec2 co){float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}vec2 decodeValue(const vec2 uv){vec4 u_color=texture2D(u_wind,uv);float u=u_wind_range[0]+((u_wind_range[1]-u_wind_range[0])*(u_color.r*255.0-1.0))/254.0;float v=u_wind_range[2]+((u_wind_range[3]-u_wind_range[2])*(u_color.g*255.0-1.0))/254.0;return vec2(u,v);}vec2 getColor(const vec2 uv){vec2 px=1.0/(u_wind_res);vec2 vc=(floor(uv*(u_wind_res)))*px;vec4 u_color=texture2D(u_wind,vc);return vec2(u_color.r,u_color.g);}vec2 lookup_wind(const vec2 uv){vec2 px=1.0/u_wind_res;vec2 vc=(floor(uv*u_wind_res))*px;vec2 f=fract(uv*u_wind_res);vec2 tl=decodeValue(vc);vec2 tr=decodeValue(vc+vec2(px.x,0));vec2 bl=decodeValue(vc+vec2(0,px.y));vec2 br=decodeValue(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}void main(){vec4 color=texture2D(u_particles,v_tex_pos);vec2 pos=fromRGBA(color);vec2 global_pos=u_bbox.xy+pos*(u_bbox.zw-u_bbox.xy);vec2 alphas=getColor(global_pos);if(alphas.x<=u_nodata||alphas.y<=u_nodata){discard;}vec2 velocity=lookup_wind(global_pos);float speed_t=length(velocity);vec2 offset=vec2(velocity.x,-velocity.y)*u_speed_factor;pos=fract(1.0+pos+offset);vec2 seed=(pos+v_tex_pos)*u_rand_seed;float drop_rate=u_drop_rate+speed_t*u_drop_rate_bump;float drop=step(1.0-drop_rate,rand(seed));vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));pos=mix(pos,random_pos,drop);gl_FragColor=toRGBA(pos);}`,te=`#define GLSLIFY 1
attribute vec2 a_pos;varying vec2 v_tex_pos;void main(){v_tex_pos=a_pos;gl_Position=vec4(a_pos*2.0-1.0,0,1);}`;const ee={callback:()=>{}};class ie{constructor(t={}){this.options={...ee,...t},this.reset(),this.animate=this.animate.bind(this),this.onVisibilityChange=this.onVisibilityChange.bind(this)}reset(){this.animating=!1,this.isVisible=!0,this.raf!==void 0&&cancelAnimationFrame(this.raf)}start(){this.animating||(this.animating=!0,document.addEventListener("visibilitychange",this.onVisibilityChange,!1),this.raf=requestAnimationFrame(this.animate))}stop(){this.reset(),document.removeEventListener("visibilitychange",this.onVisibilityChange,!1)}animate(){!this.animating||!this.isVisible||(this.options.callback((performance||Date).now()),this.raf=requestAnimationFrame(this.animate))}onVisibilityChange(){this.isVisible=!document.hidden,this.isVisible&&(this.reset(),this.start())}}const se={styleSpec:{color:["interpolate",["linear"],["get","value"],0,"#fff",100,"#fff"],opacity:1,numParticles:65535},opacity:1,lineWidth:2,speedFactor:1,fadeOpacity:.93,dropRate:.003,dropRateBump:.002};let ot=0;class re{constructor(t,e={}){if(this.gl=t,this.uid=`WindParticles_${ot}`,ot++,!this.gl)throw new Error("initialize error");this.options={...se,...e},this.opacity=this.options.opacity||1,this.visible=this.options.visible!==void 0||!0,this.alpha=.9,this.frameTime=0,this.lastTime=0,this.initialize(this.gl)}initialize(t){if(this.drawCommand=new X(t,Kt,Ht),this.drawCommand.draw=function(){this.gl.drawArrays(this.primitive,0,this.count)},this.updateCommand=new X(t,te,$t),this.updateCommand.draw=function(){this.gl.drawArrays(this.primitive,0,4)},this.screenCommand=new X(t,qt,Jt),this.screenCommand.draw=function(){this.gl.drawArrays(this.primitive,0,4)},this.fbo=t.createFramebuffer(),this.raf=new ie({callback:()=>{this.options.triggerRepaint&&this.options.triggerRepaint()}}),this.resize(),this.buildColorRamp(),typeof this.options.getZoom=="function"){const e=this.options.getZoom();this.setOpacity(T(this.uid,e,"opacity",this.options.styleSpec)),this.numParticles=T(this.uid,e,"numParticles",this.options.styleSpec)}this.start()}set numParticles(t){if(t===void 0)return;const e=this.gl,i=Math.ceil(Math.sqrt(t));this.particleStateResolution=i,this.privateNumParticles=i*i;const r=new Uint8Array(this.privateNumParticles*4);for(let a=0;a<r.length;a++)r[a]=Math.floor(Math.random()*256);this.currentParticleStateTexture?V(e,this.currentParticleStateTexture,i,i,r):this.currentParticleStateTexture=w(e,e.NEAREST,r,i,i),this.nextParticleStateTexture?V(e,this.nextParticleStateTexture,i,i,r):this.nextParticleStateTexture=w(e,e.NEAREST,r,i,i);const o=this.privateNumParticles*6,n=new Float32Array(o);for(let a=0;a<o;a++)n[a]=a;this.particleIndexBuffer?Xt(e,this.particleIndexBuffer,n):this.particleIndexBuffer=Q(e,n)}get numParticles(){return this.privateNumParticles}updateOptions(t){const e=t.styleSpec||{};if(this.options={...this.options,...t,styleSpec:{...this.options.styleSpec,...e}},this.buildColorRamp(),typeof this.options.getZoom=="function"){const i=this.options.getZoom();this.setOpacity(T(this.uid,i,"opacity",this.options.styleSpec,!0)),this.numParticles=T(this.uid,i,"numParticles",this.options.styleSpec,!0)}}setOpacity(t){this.opacity=t}getOpacity(){return this.opacity}handleMoveend(){this.updateRenderState(),z(this.gl,[0,0,0,0])}handleMovestart(){this.alpha=0}handleZoom(){if(typeof this.options.getZoom=="function"){const t=this.options.getZoom();this.setOpacity(T(this.uid,t,"opacity",this.options.styleSpec)),this.numParticles=T(this.uid,t,"numParticles",this.options.styleSpec)}}buildColorRamp(){var t;const{data:e,colorRange:i}=ut([],(t=this.options.styleSpec)==null?void 0:t.color);i&&(this.colorRange=i),e&&(this.colorRampTexture=w(this.gl,this.gl.NEAREST,e,16,16))}drawTexture(t){if(this.fbo&&this.screenTexture&&this.nextParticleStateTexture){Y(this.gl,this.fbo,this.screenTexture);const e=this.gl.isEnabled(this.gl.DEPTH_TEST),i=this.gl.isEnabled(this.gl.BLEND);this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND),this.screenCommand.active().resize(...this.size).setUniforms({u_screen:this.backgroundTexture,u_opacity:this.options.fadeOpacity,u_fade:1}).setAttributes({a_pos:{buffer:this.data.backgroundBuffer,numComponents:2},a_tex_pos:{buffer:this.data.backgroundTexCoordBuffer,numComponents:2}}).setPrimitive(this.gl.TRIANGLE_STRIP).draw(),e&&this.gl.enable(this.gl.DEPTH_TEST),i&&this.gl.enable(this.gl.BLEND),this.drawParticles(t),Y(this.gl,null),[this.backgroundTexture,this.screenTexture]=[this.screenTexture,this.backgroundTexture]}}drawScreen(){const t=this.gl.isEnabled(this.gl.DEPTH_TEST),e=this.gl.isEnabled(this.gl.BLEND);this.gl.disable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.gl.blendColor(0,0,0,0),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.screenCommand.active().resize().setUniforms({u_screen:this.screenTexture,u_opacity:this.visible?this.opacity:0,u_fade:this.alpha}).setAttributes({a_pos:{buffer:this.data.buffer,numComponents:2},a_tex_pos:{buffer:this.data.texCoordBuffer,numComponents:2}}).setPrimitive(this.gl.TRIANGLE_STRIP).draw(),t&&this.gl.enable(this.gl.DEPTH_TEST),e||this.gl.disable(this.gl.BLEND)}updateParticles(){if(this.fbo&&this.currentParticleStateTexture&&this.nextParticleStateTexture){Y(this.gl,this.fbo,this.nextParticleStateTexture);const t=this.options.speedFactor*2.5,e=this.gl.isEnabled(this.gl.DEPTH_TEST),i=this.gl.isEnabled(this.gl.BLEND);this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND),this.updateCommand.active().resize(this.particleStateResolution,this.particleStateResolution).setUniforms({u_wind_res:[this.data.width,this.data.height],u_rand_seed:Math.random(),u_wind_range:[this.data.uMin,this.data.uMax,this.data.vMin,this.data.vMax],u_drop_rate:this.options.dropRate,u_drop_rate_bump:this.options.dropRateBump,u_speed_factor:[t*this.frameTime/this.size[0],t*this.frameTime/this.size[1]],u_wind:this.data.texture,u_bbox:this.renderExtent,nodata:this.data.nodata,u_particles:this.currentParticleStateTexture}).setAttributes({a_pos:{buffer:this.data.quadBuffer,numComponents:2}}).setPrimitive(this.gl.TRIANGLE_STRIP).draw(),e&&this.gl.enable(this.gl.DEPTH_TEST),i&&this.gl.enable(this.gl.BLEND),[this.currentParticleStateTexture,this.nextParticleStateTexture]=[this.nextParticleStateTexture,this.currentParticleStateTexture]}}drawParticles(t){if(this.particleIndexBuffer&&this.currentParticleStateTexture&&this.nextParticleStateTexture){const e=this.gl.isEnabled(this.gl.DEPTH_TEST),i=this.gl.isEnabled(this.gl.BLEND);this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.BLEND);const r=this.options.getZoom(),o=this.options.getWorlds();for(let n=0;n<o.length;n++)this.drawCommand.active().setUniforms({u_width:this.options.lineWidth,u_world:this.size,u_matrix:t,u_zoom:r,u_bbox:this.renderExtent,u_offset:o[n],u_wind:this.data.texture,u_wind_res:[this.data.width,this.data.height],u_wind_range:[this.data.uMin,this.data.uMax,this.data.vMin,this.data.vMax],u_color_ramp:this.colorRampTexture,u_color_range:this.colorRange,u_aspectRatio:this.size[0]/this.size[1],u_particles_current:this.currentParticleStateTexture,u_particles_next:this.nextParticleStateTexture,u_particles_res:this.particleStateResolution}).setAttributes({a_index:{buffer:this.particleIndexBuffer,numComponents:1}}).setPrimitive(this.gl.TRIANGLES).runTimes(this.particleStateResolution**2*6).draw();i&&this.gl.enable(this.gl.BLEND),e&&this.gl.enable(this.gl.DEPTH_TEST)}}updateRenderState(){this.renderExtent=this.options.getExtent()}resize(){const t=this.gl;this.size=this.options.getSize(),this.updateRenderState();const e=new Uint8Array(this.size[0]*this.size[1]*4);this.backgroundTexture?V(t,this.backgroundTexture,this.size[0],this.size[1],e):this.backgroundTexture=w(t,t.NEAREST,e,this.size[0],this.size[1]),this.screenTexture?V(t,this.screenTexture,this.size[0],this.size[1],e):this.screenTexture=w(t,t.NEAREST,e,this.size[0],this.size[1]),this.fbo&&Vt(t,this.fbo,this.size[0],this.size[1],this.screenTexture)}start(){this.raf.start(),this.options.triggerRepaint&&this.options.triggerRepaint()}stop(){this.raf.stop(),z(this.gl,[0,0,0,0]),this.options.triggerRepaint&&this.options.triggerRepaint()}prerender(t){if(this.data){this.updateParticles(),this.drawTexture(t);const e=.001*Date.now();this.frameTime=Math.min(e-(this.lastTime||0),.05),this.lastTime=e}}render(){return this.data&&(this.options.interacting()&&this.alpha<1&&(this.alpha+=3*this.frameTime,(this.alpha>1||!this.frameTime)&&(this.alpha=1)),this.drawScreen()),this}initializeVertex(t){let e=0;const i=t.length,r=new Float32Array(i*2);for(;e<i;e++){const o=t[e],n=this.getMercatorCoordinate(o);r[e*2]=n[0],r[e*2+1]=n[1]}return{quadBuffer:Q(this.gl,new Float32Array([0,0,0,1,1,0,1,1])),buffer:Q(this.gl,r),texCoordBuffer:Q(this.gl,new Float32Array([0,0,0,1,1,0,1,1])),backgroundBuffer:Q(this.gl,new Float32Array([0,0,0,1,1,0,1,1])),backgroundTexCoordBuffer:Q(this.gl,new Float32Array([0,0,0,1,1,0,1,1]))}}getTextureData(t){return new Promise((e,i)=>{t.type==="image"&&t.url&&ht(t.url).then(r=>{const o={width:r.width,height:r.height,texture:w(this.gl,this.gl.LINEAR,r,r.width,r.height),nodata:t.nodata||0,...this.initializeVertex(t.extent)};o.uMin=t.uMin,o.uMax=t.uMax,o.vMin=t.vMin,o.vMax=t.vMax,e(o)}).catch(r=>i(r))})}setData(t,e){this.gl&&t&&this.getTextureData(t).then(i=>{this.data=i,e&&e(!0),this.options.triggerRepaint&&this.options.triggerRepaint()}).catch(i=>{e&&e(!1),console.error(i)})}getData(){return this.data}getMercatorCoordinate([t,e]){return[t,e]}destroyData(){if(this.data){const{texture:t,quadBuffer:e,buffer:i,texCoordBuffer:r,backgroundBuffer:o,backgroundTexCoordBuffer:n}=this.data;t&&this.gl.deleteTexture(t),i&&this.gl.deleteBuffer(i),e&&this.gl.deleteBuffer(e),r&&this.gl.deleteBuffer(r),o&&this.gl.deleteBuffer(o),n&&this.gl.deleteBuffer(n),delete this.data}}destroyed(){this.stop(),this.currentParticleStateTexture&&(this.gl.deleteTexture(this.currentParticleStateTexture),this.currentParticleStateTexture=null),this.nextParticleStateTexture&&(this.gl.deleteTexture(this.nextParticleStateTexture),this.nextParticleStateTexture=null),this.backgroundTexture&&(this.gl.deleteTexture(this.backgroundTexture),this.backgroundTexture=null),this.screenTexture&&(this.gl.deleteTexture(this.screenTexture),this.screenTexture=null),this.fbo&&(this.gl.deleteFramebuffer(this.fbo),this.fbo=null),this.destroyData()}}function nt(s){return s?(s.parentNode&&s.parentNode.removeChild(s),s):null}class oe{constructor(t,e={}){if(!t)throw Error("layer id must be specified");this.id=t,this.options=e,this.canvas=null,this.canvas2=null,this.devicePixelRatio=this.options.devicePixelRatio||window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI,this.render=this.render.bind(this),this.type="custom",this.renderingMode="2d"}onAdd(t){this.setMap(t),this.canvas=this.initialize(),this.options.doubleBuffer&&(this.canvas2=this.initialize())}resizeCanvas(t){const e=this.map.getCanvas(),{width:i,height:r}=this.map.transform,o=this.devicePixelRatio;t.width=i*o,t.height=r*o,t.style.width=e.style.width,t.style.height=e.style.height}initialize(){const t=this.map.getCanvasContainer(),e=this.map.getCanvas(),i=document.createElement("canvas"),{width:r,height:o}=this.map.transform,n=this.devicePixelRatio;return i.width=r*n,i.height=o*n,i.style.position="absolute",i.className="mapbox-overlay-canvas",i.style.width=e.style.width,i.style.height=e.style.height,t.appendChild(i),i}render(){}project(t){if(this.map!==void 0){const e=this.map.project(new x.exports.LngLat(t[0],t[1])),i=e.x,r=e.y;return[i*this.devicePixelRatio,r*this.devicePixelRatio]}return t}unproject(t){if(this.map!==void 0){const e=this.map.unproject(new x.exports.Point(t[0],t[1]));return[e.lng,e.lat]}return t}intersectsCoordinate(t){var e,i;const r=this.map.getBounds(),o=(i=(e=this.map)==null?void 0:e.transform)==null?void 0:i.latRange;return o&&(t[1]>o[1]||t[1]<o[0])?!1:r.contains(new x.exports.LngLat(t[0],t[1]))}clear(){if(this.canvas){const t=this.canvas.getContext("2d");t&&t.clearRect(0,0,this.canvas.width,this.canvas.height)}if(this.canvas2){const t=this.canvas2.getContext("2d");t&&t.clearRect(0,0,this.canvas2.width,this.canvas2.height)}}setMap(t){return this.map=t,this}getMap(){return this.map}addTo(t){this.onAdd(t)}remove(){this.canvas&&(nt(this.canvas),this.canvas=null),this.canvas2&&(nt(this.canvas2),this.canvas2=null)}}function ne([s,t]){const e=x.exports.MercatorCoordinate.fromLngLat({lng:s,lat:t});return[e.x,e.y]}class he{constructor(t,e,i){this.id=t,this.type="custom",this.renderingMode="3d",this.options={...i||{}},this.data=e,this.handleZoom=this.handleZoom.bind(this)}handleZoom(){this.scalarFill&&this.scalarFill.handleZoom()}initialize(){!this.scalarFill&&this.gl&&(this.scalarFill=new jt(this.gl,{opacity:this.options.opacity,renderForm:this.options.renderForm,styleSpec:this.options.styleSpec,displayRange:this.options.displayRange,mappingRange:this.options.mappingRange,widthSegments:this.options.widthSegments,heightSegments:this.options.heightSegments,wireframe:this.options.wireframe,createPlaneBuffer:this.options.createPlaneBuffer,getZoom:()=>this.map.getZoom(),triggerRepaint:()=>{this.map.triggerRepaint()},injectShaderModules:{"#modules-transformZ":`
const float MATH_PI = 3.141592653589793;
const float earthRadius = 6371008.8;
const float earthCircumfrence = 2.0 * MATH_PI * earthRadius;

            float latFromMercatorY(float y) {
  float y2 = 180.0 - y * 360.0;
  return 360.0 / MATH_PI * atan(exp(y2 * MATH_PI / 180.0)) - 90.0;
}

float circumferenceAtLatitude(float latitude) {
  return earthCircumfrence * cos(latitude * MATH_PI / 180.0);
}

float mercatorScale(float lat) {
  return 1.0 / cos(lat * MATH_PI / 180.0);
}

float transformZ(float value, vec3 pos) {
  float mercatorY = pos.y;
  //  float scale = circumferenceAtLatitude(latFromMercatorY(mercatorY));
  float scale = earthCircumfrence * mercatorScale(latFromMercatorY(mercatorY));

  return value / scale;
}
          `,"#modules-project":`
gl_Position = u_matrix * vec4(pos.xy + vec2(u_offset, 0.0), pos.z + z, pos.w);
gl_Position.w += u_cameraEye.w;
    `}}),this.scalarFill.getMercatorCoordinate=ne,this.map.on("zoom",this.handleZoom)),this.data&&this.setData(this.data)}updateOptions(t){this.options={...this.options,...t||{}},this.scalarFill&&this.scalarFill.updateOptions(t)}onAdd(t,e){this.gl=e,this.map=t,this.map&&this.initialize()}setData(t){return new Promise((e,i)=>{this.data=t,this.data&&this.scalarFill?this.scalarFill.setData(this.data,r=>{r?e(!0):i(!1)}):e(!1)})}onRemove(t){this.scalarFill&&(this.scalarFill.destroyed(),this.scalarFill=null),delete this.gl,delete this.map,t.off("zoom",this.handleZoom)}getWrappedWorlds(){const t=[0];if(this.options.wrapX){const{width:e,height:i}=this.map.transform,r=this.map.transform.pointCoordinate(new x.exports.Point(0,0)),o=this.map.transform.pointCoordinate(new x.exports.Point(e,0)),n=this.map.transform.pointCoordinate(new x.exports.Point(e,i)),a=this.map.transform.pointCoordinate(new x.exports.Point(0,i)),c=Math.floor(Math.min(r.x,o.x,n.x,a.x)),l=Math.floor(Math.max(r.x,o.x,n.x,a.x)),h=1;for(let u=c-h;u<=l+h;u++)u!==0&&t.push(u)}return t}render(t,e){const i=Gt(e),r=i.map(o=>Z(o));if(this.data&&this.scalarFill){const o=this.getWrappedWorlds();for(let n=0;n<o.length;n++)this.scalarFill.render(e,o[n],{cameraEye:i,cameraEye64Low:r})}}}function ae([s,t]){const e=x.exports.MercatorCoordinate.fromLngLat({lng:s,lat:t});return[e.x,e.y]}class ue{constructor(t,e,i){this.id=t,this.type="custom",this.renderingMode="2d",this.options={...i||{}},this.data=e,this.resize=this.resize.bind(this),this.handleZoom=this.handleZoom.bind(this),this.handleMovestart=this.handleMovestart.bind(this),this.handleMoveend=this.handleMoveend.bind(this)}updateOptions(t){this.options={...this.options,...t||{}},this.layer&&this.layer.updateOptions(t)}handleZoom(){this.layer&&this.layer.handleZoom()}resize(){this.layer&&this.layer.resize()}handleMovestart(){this.layer&&this.layer.handleMovestart()}handleMoveend(){this.layer&&this.layer.handleMoveend()}initialize(){!this.layer&&this.gl&&(this.layer=new re(this.gl,{getZoom:()=>this.map.getZoom(),triggerRepaint:()=>{this.map.triggerRepaint()},getExtent:()=>{const t=this.map.getBounds().toArray();let e=t[0][0];const i=t[0][1];let r=t[1][0];const o=t[1][1];this.getWrappedWorlds().length>1?(e=-180,r=180):(e<-180&&(e=-180),r>180&&(r=180));const a=x.exports.MercatorCoordinate.fromLngLat(new x.exports.LngLat(e,o)),c=x.exports.MercatorCoordinate.fromLngLat(new x.exports.LngLat(r,i));return[a.x,a.y,c.x,c.y]},getSize:()=>[this.map.transform.size.x,this.map.transform.size.y],interacting:()=>!this.map.painter.options.moving&&!this.map.painter.options.rotating&&!this.map.painter.options.zooming,getWorlds:()=>this.getWrappedWorlds(),...this.options}),this.layer.getMercatorCoordinate=ae,this.map.on("zoom",this.handleZoom),this.map.on("movestart",this.handleMovestart),this.map.on("resize",this.resize),this.map.on("moveend",this.handleMoveend)),this.data&&this.setData(this.data)}onAdd(t,e){this.gl=e,this.map=t,this.map&&this.initialize()}setData(t){return new Promise((e,i)=>{this.data=t,this.data&&this.layer?this.layer.setData(this.data,r=>{r?e(!0):i(!1)}):e(!1)})}onRemove(t){this.layer&&(this.layer.destroyed(),this.layer=null),t.off("zoom",this.handleZoom),t.off("movestart",this.handleMovestart),t.off("resize",this.resize),t.off("moveend",this.handleMoveend),delete this.gl,delete this.map}getWrappedWorlds(){const t=[0];if(this.options.wrapX){const{width:e,height:i}=this.map.transform,r=this.map.transform.pointCoordinate(new x.exports.Point(0,0)),o=this.map.transform.pointCoordinate(new x.exports.Point(e,0)),n=this.map.transform.pointCoordinate(new x.exports.Point(e,i)),a=this.map.transform.pointCoordinate(new x.exports.Point(0,i)),c=Math.floor(Math.min(r.x,o.x,n.x,a.x)),l=Math.floor(Math.max(r.x,o.x,n.x,a.x)),h=0;for(let u=c-h;u<=l+h;u++)u!==0&&t.push(u)}return t}prerender(t,e){this.data&&this.layer&&this.layer.prerender(e)}render(t,e){this.data&&this.layer&&this.layer.render(e)}}const ce={doubleBuffer:!1,windOptions:O};class de extends oe{constructor(t,e,i={}){super(t,{...ce,...i}),this.pickWindOptions(),e&&this.setData(e,i.fieldOptions),this.stop=this.stop.bind(this),this.render=this.render.bind(this),this.handleResize=this.handleResize.bind(this)}onAdd(t){if(super.onAdd(t),!this.map)throw new Error("map is null");this.canvas!==null&&(this.render(),this.registerEvents())}handleResize(){this.canvas&&this.resizeCanvas(this.canvas),this.render()}registerEvents(){this.map.on("resize",this.handleResize),this.map.on("movestart",this.stop),this.map.on("moveend",this.render),this.map.on("zoomstart",this.stop),this.map.on("zoomend",this.render),this.map.on("rotatestart",this.stop),this.map.on("rotateend",this.render),this.map.on("pitchstart",this.stop),this.map.on("pitchend",this.render)}unregisterEvents(){this.map.off("resize",this.handleResize),this.map.off("movestart",this.stop),this.map.off("moveend",this.render),this.map.off("zoomstart",this.stop),this.map.off("zoomend",this.render),this.map.off("rotatestart",this.stop),this.map.off("rotateend",this.render),this.map.off("pitchstart",this.stop),this.map.off("pitchend",this.render)}stop(){this.wind&&this.wind.clearCanvas()}render(){if(!this.map)return;const t=this.getWindOptions();if(!this.wind&&this.map&&this.canvas!==null){const e=this.canvas.getContext("2d");if(!e){console.error("create canvas context failed");return}const i=this.getData();this.wind=new ct(e,t,i),this.wind.project=this.project.bind(this),this.wind.unproject=this.unproject.bind(this),this.wind.intersectsCoordinate=this.intersectsCoordinate.bind(this),this.wind.postrender=()=>{}}this.wind.prerender(),this.wind.render()}remove(){super.remove(),this.wind&&this.wind.stop(),this.unregisterEvents()}pickWindOptions(){Object.keys(O).forEach(t=>{this.options&&t in this.options&&(this.options.windOptions===void 0&&(this.options.windOptions={}),this.options.windOptions[t]=this.options[t])})}getData(){return this.field}setData(t,e={}){var i;return t&&t.checkFields&&t.checkFields()?this.field=t:mt(t)?this.field=It(t,e):console.error("Illegal data"),this.field&&((i=this==null?void 0:this.wind)==null||i.updateData(this.field)),this}setWindOptions(t){const e=this.options.windOptions||{};if(this.options=k(this.options,{windOptions:k(e,t||{})}),this.wind){const i=this.options.windOptions;this.wind.setOptions(i),this.wind.prerender()}}getWindOptions(){return this.options.windOptions||{}}}export{at as Field,ue as Particles,he as ScalarFill,de as WindLayer,de as default};
